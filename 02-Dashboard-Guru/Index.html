
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="shortcut icon" href="https://drive.google.com/thumbnail?id=1B6dqG4V87Ce0CdxFDkSYAPW4hqjxYCiB&sz=w500">
    <title>Dashboard Guru - Si Pintar</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
      /* --- 1. CSS DASAR & LAYOUT --- */
      body { 
        font-family: 'Roboto', sans-serif; 
        margin: 0; 
        color: #333; 
        padding-bottom: 80px; 
        
        /* BACKGROUND SETTING */
        background-image: url('https://drive.google.com/thumbnail?id=1lmAkTJIfmQxxDhAD_c6Ah2THfFBGny3s&sz=w1920');
        background-color: #f4f6f9; /* Warna cadangan jika gambar gagal */
        background-size: cover;    /* Memenuhi layar */
        background-position: center; /* Posisi tengah */
        background-attachment: fixed; /* Gambar diam saat di-scroll (Efek Keren) */
        background-repeat: no-repeat;
      }
      
      /* NAVBAR STYLING */
      .navbar { 
        background: linear-gradient(135deg, #007bff, #0056b3); 
        color: white; 
        padding: 15px 20px; 
        position: sticky; 
        top: 0; 
        z-index: 100; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        border-bottom-left-radius: 20px; 
        border-bottom-right-radius: 20px; 
      }
      .profile-area { display: flex; align-items: center; justify-content: space-between; }
      .user-identity { display: flex; align-items: center; gap: 12px; }
      .dashboard-profile-img { 
        width: 50px; height: 50px; 
        border-radius: 50%; 
        border: 2px solid rgba(255,255,255,0.8); 
        object-fit: cover; 
        background: white; 
      }
      .guru-info h2 { margin: 0; font-size: 16px; font-weight: 700; } 
      .guru-info p { margin: 0; font-size: 11px; opacity: 0.9; }
      .btn-logout { 
        background: rgba(255,255,255,0.2); 
        border: none; padding: 8px 12px; 
        border-radius: 10px; color: white; 
        cursor: pointer; font-weight: bold; 
        font-size: 11px; display: flex; 
        align-items: center; gap: 5px; 
      }
      
      .container { 
        padding: 15px; /* Padding lebih kecil (15px) pas untuk HP */
        max-width: 1000px; 
        margin: auto; 
        box-sizing: border-box; 
      }
      /* Wrapper agar judul benar-benar di tengah */
      .title-wrapper { text-align: center; margin-top: 20px; margin-bottom: 10px; }
      
      .section-title { 
        font-size: 13px; 
        font-weight: 800; 
        color: #444; 
        text-transform: uppercase; 
        display: inline-block; /* Agar garis bawah mengikuti panjang teks */
        border-bottom: 3px solid #007bff; /* Garis bawah biru */
        padding-bottom: 5px;
        letter-spacing: 0.5px;
      }
      
      /* --- 2. MENU GRID & ICON --- */
      /* --- UPGRADE MENU: FLEXBOX AUTO CENTER --- */
      
      .menu-grid { 
        display: flex;           /* Pakai Flexbox biar luwes */
        flex-wrap: wrap;         /* Biar bisa turun baris */
        justify-content: center; /* KUNCI: Ratakan isi ke tengah */
        gap: 12px;               /* Jarak antar kotak */
        margin-bottom: 30px; 
      }

      .menu-item { 
        background: white; 
        border-radius: 15px; 
        padding: 15px 10px; 
        text-align: center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        transition: transform 0.2s; 
        cursor: pointer; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        height: 100px;
        
        /* LOGIKA LEBAR KOTAK */
        /* HP: 2 Kolom (50% layar dikurangi gap) */
        width: calc(50% - 15px); 
        box-sizing: border-box; /* Agar padding tidak melebarkan kotak */
      }

      /* TAMPILAN TABLET (3 KOLOM) */
      @media (min-width: 600px) { 
        .menu-item { width: calc(33.33% - 15px); } 
      }
      
      /* TAMPILAN LAPTOP (6 KOLOM) */
      @media (min-width: 900px) { 
        .menu-item { width: calc(16.66% - 15px); } 
      }
      .menu-item:active { transform: scale(0.95); background: #f0f0f0; }
      
      .icon-box { 
        font-size: 24px; margin-bottom: 8px; width: 45px; height: 45px; 
        border-radius: 12px; display: flex; align-items: center; 
        justify-content: center; color: white; 
      }
      .menu-label { font-size: 11px; font-weight: 500; color: #444; line-height: 1.3; }
      
      /* WARNA ICON */
      .bg-blue { background: linear-gradient(135deg, #3498db, #2980b9); } 
      .bg-green { background: linear-gradient(135deg, #2ecc71, #27ae60); } 
      .bg-orange { background: linear-gradient(135deg, #f39c12, #d35400); } 
      .bg-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); } 
      .bg-red { background: linear-gradient(135deg, #e74c3c, #c0392b); } 
      .bg-teal { background: linear-gradient(135deg, #1abc9c, #16a085); } 
      .bg-dark { background: linear-gradient(135deg, #34495e, #2c3e50); }

      /* --- 3. KOMPONEN UMUM (Form, Button, Tab) --- */
      .hidden-page { display: none; }
      .btn-back { display: inline-block; margin-bottom: 15px; color: #007bff; text-decoration: none; font-weight: bold; cursor: pointer; }
      .form-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
      .form-group { margin-bottom: 15px; }
      .form-label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold; color: #555; }
      .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
      
      .btn-simpan { width: 100%; background: #007bff; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
      .btn-simpan:hover { opacity: 0.9; }
      
      .btn-mini { padding: 4px 8px; font-size: 10px; border-radius: 4px; border: none; cursor: pointer; color: white; margin: 2px; }
      .btn-edit { background: #ffc107; color: #333; } 
      .btn-hapus { background: #dc3545; }
      
      .presensi-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
      .tab-btn { flex: 1; padding: 10px; background: #eee; border: none; border-radius: 8px; font-weight: bold; color: #666; cursor: pointer; }
      .tab-btn.active { background: #007bff; color: white; }

      /* --- 4. STYLE KHUSUS (Tabel, Nilai, Cetak) --- */
      .inp-nilai { width:100%; border:none; border-bottom:1px solid #eee; text-align:center; font-size:11px; outline:none; padding:5px 0; background: transparent; }
      .inp-nilai:focus { border-bottom:2px solid #007bff; background:#f0f8ff; }
      .header-input { width:90%; border:none; background:transparent; font-weight:bold; text-align:center; font-size:10px; }
      .header-input:focus { border-bottom: 1px solid #007bff; }
      #nilai-container table { min-width: 900px; }

      .doc-header { margin-bottom: 20px; display: none; text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; } 
      .doc-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px; background: white; }
      .doc-table th, .doc-table td { border: 1px solid #333; padding: 6px; vertical-align: top; text-align: left; }
      .doc-table th { background: #f8f9fa; text-align: center; font-weight: bold; }
      
      .signature-table { width: 100%; border: none; margin-top: 30px; display: none; }
      .signature-table td { border: none; text-align: center; vertical-align: top; padding: 0; }
      .bold-underline { font-weight: bold; text-decoration: underline; }
      .ttd-space { height: 70px; }

      /* --- CSS CETAK (REVISI FINAL: HANYA CETAK HALAMAN AKTIF) --- */
      @media print {
         @page { size: portrait; margin: 20px; }
         body { background: white; padding: 0; margin: 0; }
         
         /* 1. SEMBUNYIKAN SEMUA ELEMENT NAVIGASI & TOMBOL EDIT */
         .navbar, .bottom-nav, .btn-back, .btn-logout, .presensi-tabs, 
         .form-card.btn-print-hide, .btn-simpan, .btn-mini, 
         .section-title, .btn-print-hide, .menu-grid, #menu-utama,
         .btn-edit, .btn-hapus, #panel-kontrol-nilai { 
            display: none !important; 
         }
         
         /* 2. TAMPILKAN FORMAT DOKUMEN YANG BENAR */
         /* Kita tidak memaksa ID tertentu muncul. Browser akan mencetak apa yang sedang tampil (display:block) */
         
         .container { max-width: 100%; padding: 0; margin: 0; }
         .form-card { box-shadow: none; border: none; padding: 0; margin: 0; }
         
         /* Header & Tanda Tangan Wajib Muncul */
         .doc-header { display: block !important; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
         .signature-table { display: table !important; width: 100%; margin-top: 30px; page-break-inside: avoid; }
         
         /* Perbaikan Tabel Cetak */
         .doc-table { width: 100%; border-collapse: collapse; }
         .doc-table th, .doc-table td { 
             border: 1px solid #000 !important; 
             color: #000 !important; 
             padding: 8px;
         }
         
         /* Pastikan Header Input (Nilai) terlihat sebagai teks biasa */
         .header-input { border: none !important; text-align: center; font-weight: bold; }
      }
      /* --- 5. STYLE BARU: BOTTOM NAVIGATION (MENU BAWAH) --- */
      .bottom-nav {
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        background: white;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        z-index: 999;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      
      .nav-item {
        text-align: center;
        color: #b0bec5; /* Abu-abu mati */
        cursor: pointer;
        flex: 1;
        transition: 0.3s;
      }
      
      .nav-item.active {
        color: #007bff; /* Biru Aktif */
        transform: translateY(-5px);
      }
      
      .nav-icon { font-size: 20px; margin-bottom: 2px; display: block; }
      .nav-text { font-size: 10px; font-weight: 600; }

      /* Card Profil Baru */
      .profile-card-big {
        background: white; border-radius: 20px; padding: 30px 20px;
        text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        margin-top: 20px;
      }
      .badge-premium {
        background: #ffc107; color: #333; padding: 5px 15px; 
        border-radius: 20px; font-size: 10px; font-weight: bold; 
        display: inline-block; margin-top: 10px;
      }
      
      /* Agar konten tidak tertutup menu bawah */
      body { padding-bottom: 90px; }
    </style>
  </head>
  <body>

    <div class="navbar">
      <div class="profile-area">
        <div class="user-identity">
           <? var linkFoto = (fotoId) ? "https://drive.google.com/thumbnail?id=" + fotoId + "&sz=w100" : "https://cdn-icons-png.flaticon.com/512/3135/3135715.png"; ?>
           <img src="<?= linkFoto ?>" class="dashboard-profile-img">
           <div class="guru-info">
              <h2 style="font-size:14px;">Halo, <?= namaGuru ?></h2>
              <p style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px; font-size:10px;">Guru Mapel</p>
           </div>
        </div>
        <div style="color:#ffeb3b; font-size:18px;"><i class="fas fa-crown"></i></div> 
      </div>
    </div>

    <div class="container" style="margin-top: 15px;">
      
      <div style="background:white; padding:15px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div>
             <h4 style="margin:0; font-size:13px; color:#333;" id="header-sekolah">SMP NEGERI 1 MODAYAG</h4>
             <p style="margin:0; font-size:11px; color:#888;">Tahun Ajaran 2025/2026</p>
          </div>
          <div style="background:#e3f2fd; padding:8px; border-radius:10px; color:#007bff;"><i class="fas fa-exchange-alt"></i></div>
      </div>

      <div id="tab-beranda" class="main-tab">
          
          <div class="title-wrapper"><div class="section-title">Menu Utama</div></div>
          <div class="menu-grid">
             <div class="menu-item" onclick="bukaMenu('Kalender')"><div class="icon-box bg-blue"><i class="fas fa-calendar-alt"></i></div><div class="menu-label">Kalender</div></div>
             <div class="menu-item" onclick="bukaMenu('Jadwal')"><div class="icon-box bg-blue"><i class="fas fa-clock"></i></div><div class="menu-label">Jadwal</div></div>
             <div class="menu-item" onclick="bukaMenu('Murid')"><div class="icon-box bg-teal"><i class="fas fa-users"></i></div><div class="menu-label">Siswa</div></div>
             <div class="menu-item" onclick="bukaMenu('Presensi')"><div class="icon-box bg-teal"><i class="fas fa-user-check"></i></div><div class="menu-label">Kehadiran</div></div>
          </div>

          <div class="title-wrapper"><div class="section-title">Perangkat & Ujian</div></div>
          <div class="menu-grid">
             <div class="menu-item" onclick="bukaMenu('CP')"><div class="icon-box bg-purple"><i class="fas fa-bullseye"></i></div><div class="menu-label">CP</div></div>
             <div class="menu-item" onclick="bukaMenu('TP')"><div class="icon-box bg-purple"><i class="fas fa-crosshairs"></i></div><div class="menu-label">TP</div></div>
             <div class="menu-item" onclick="bukaMenu('ATP')"><div class="icon-box bg-purple"><i class="fas fa-route"></i></div><div class="menu-label">ATP</div></div>
             <div class="menu-item" onclick="bukaMenu('Modul')"><div class="icon-box bg-purple"><i class="fas fa-book"></i></div><div class="menu-label">Modul</div></div>
             <div class="menu-item" onclick="bukaMenu('KKTP')"><div class="icon-box bg-orange"><i class="fas fa-chart-line"></i></div><div class="menu-label">KKTP</div></div>
             <div class="menu-item" onclick="bukaMenu('Prosem')"><div class="icon-box bg-orange"><i class="fas fa-business-time"></i></div><div class="menu-label">Prosem</div></div>
             <div class="menu-item" onclick="bukaNilai()"><div class="icon-box bg-green"><i class="fas fa-star"></i></div><div class="menu-label">Nilai</div></div>
             <div class="menu-item" onclick="bukaAgenda()"><div class="icon-box bg-green"><i class="fas fa-journal-whills"></i></div><div class="menu-label">Jurnal</div></div>
             <div class="menu-item" onclick="bukaBankSoal()"><div class="icon-box bg-red"><i class="fas fa-file-alt"></i></div><div class="menu-label">Bank Soal</div></div>
             <div class="menu-item" onclick="bukaMenu('PAS')"><div class="icon-box bg-red"><i class="fas fa-laptop-code"></i></div><div class="menu-label">Ujian</div></div>
          </div>
          
          <div style="background:#e1f5fe; border-radius:15px; padding:15px; display:flex; align-items:center; gap:15px; margin-top:10px; margin-bottom:30px;">
             <i class="fas fa-info-circle fa-2x" style="color:#0288d1;"></i>
             <div>
                <h4 style="margin:0; font-size:12px; color:#0277bd;">Si-Pintar Mobile</h4>
                <p style="margin:0; font-size:10px; color:#555;">Kelola administrasi kelas dalam genggaman.</p>
             </div>
          </div>
      </div>

      <div id="tab-pengaturan" class="main-tab" style="display:none;">
          <div class="title-wrapper"><div class="section-title">Pengaturan Aplikasi</div></div>
          <div id="area-form-pengaturan"></div> </div>

      <div id="tab-profil" class="main-tab" style="display:none;">
          <div class="profile-card-big">
              <img src="<?= linkFoto ?>" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid #f0f0f0;">
              <h3 style="margin:10px 0 5px 0;"><?= namaGuru ?></h3>
              <p style="color:#888; font-size:12px; margin:0;">Dashboard Guru</p>
              
              <div class="badge-premium"><i class="fas fa-crown"></i> AKUN PREMIUM</div>
              
              <div style="margin-top:30px; text-align:left;">
                  <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                     <span><i class="fas fa-school" style="color:#007bff; width:25px;"></i> Sekolah</span>
                     <span style="font-weight:bold; color:#555;" id="prof-sekolah">SMP N 1 Modayag</span>
                  </div>
                  <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                     <span><i class="fas fa-book" style="color:#28a745; width:25px;"></i> Mapel</span>
                     <span style="font-weight:bold; color:#555;" id="prof-mapel">Matematika</span>
                  </div>
              </div>

              <button onclick="logout()" class="btn-simpan bg-red" style="margin-top:30px;">
                 <i class="fas fa-sign-out-alt"></i> KELUAR APLIKASI
              </button>
          </div>
      </div>
      <div id="page-kalender" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üìÖ Kalender Akademik & Agenda</h3>
         
         <div class="form-card">
             <h4 style="margin:0 0 10px 0; color:#007bff; border-bottom:1px solid #eee;">Visual Kalender</h4>
             <div id="kalender-visual-area" style="text-align:center; min-height: 200px;">
                 <div id="loader-kalender">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color:#007bff;"></i>
                    <p style="color:#666; margin-top:10px;">Sedang mengambil Data...</p>
                 </div>
                 <img id="img-kalender" src="" style="max-width:100%; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:none; margin-bottom:15px;">
                 
                 <div id="btn-area-kalender" style="display:none;">
                    <a id="link-download-kalender" href="#" target="_blank" class="btn-simpan bg-orange" style="text-decoration:none; display:inline-block; width:auto; padding:8px 20px;">
                       <i class="fas fa-file-pdf"></i> Download PDF
                    </a>
                 </div>
                 <p id="msg-error-kalender" style="color:red; display:none; margin-top:10px;">
                    Gambar belum muncul? Cek ID File di menu Pengaturan.
                 </p>
             </div>
         </div>

         <div class="form-card btn-print-hide" style="margin-top:20px; background:#f0f8ff;">
             <h4 style="margin:0 0 10px 0; color:#007bff;">Kelola Agenda</h4>
             <input type="hidden" id="kal-rowIndex"> <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end;">
                 <div class="form-group" style="margin:0"><label class="form-label">Tanggal</label><input type="text" id="kal-tanggal" class="form-control" placeholder="Cth: 17 Agustus 2025"></div>
                 <div class="form-group" style="margin:0"><label class="form-label">Kegiatan</label><input type="text" id="kal-kegiatan" class="form-control" placeholder="Nama Kegiatan"></div>
                 <div class="form-group" style="margin:0"><label class="form-label">Label</label>
                    <select id="kal-label" class="form-control">
                        <option value="sekolah">Sekolah (Masuk)</option>
                        <option value="libur">Libur</option>
                    </select>
                 </div>
                 <button class="btn-simpan bg-green" onclick="simpanAgendaKalender()" id="btn-kal-simpan" style="margin:0; width:auto;"><i class="fas fa-plus"></i> TAMBAH</button>
                 <button class="btn-mini bg-red" onclick="resetFormKalender()" id="btn-kal-batal" style="display:none; height:40px;">Batal</button>
             </div>
         </div>

         <div class="form-card" style="margin-top:10px;">
             <h4 style="margin:0 0 15px 0; color:#007bff; border-bottom:1px solid #eee;">Daftar Agenda Kegiatan</h4>
             <div style="overflow-x:auto;">
               <table class="doc-table" style="width:100%">
                  <thead>
                     <tr style="background:#f8f9fa;">
                        <th width="5%">No</th>
                        <th width="25%">Tanggal</th>
                        <th>Kegiatan</th>
                        <th width="10%">Label</th>
                        <th width="15%" class="btn-print-hide">Aksi</th>
                     </tr>
                  </thead>
                  <tbody id="tabel-agenda-body">
                     </tbody>
               </table>
             </div>
         </div>
      </div>

      <div id="page-jadwal" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üïí Jadwal Pelajaran</h3>
         
         <div class="form-card btn-print-hide" style="background:#e8f5e9;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#28a745;">Kelola Jadwal</h4>
                <button class="btn-mini bg-red" id="btn-jad-batal" onclick="resetFormJadwal()" style="display:none;">Batal Edit</button>
             </div>
             
             <input type="hidden" id="jad-rowIndex"> 
             <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto; gap:8px; align-items:end;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Hari</label>
                    <select id="jad-hari" class="form-control">
                        <option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option><option>Sabtu</option>
                    </select>
                 </div>
                 <div class="form-group" style="margin:0"><label class="form-label">Jam Ke</label><input type="number" id="jad-jam" class="form-control" placeholder="1"></div>
                 <div class="form-group" style="margin:0"><label class="form-label">Waktu</label><input type="text" id="jad-waktu" class="form-control" placeholder="07.30 - 08.10"></div>
                 <div class="form-group" style="margin:0"><label class="form-label">Kelas</label><input type="text" id="jad-kelas" class="form-control" placeholder="7A"></div>
                 <div class="form-group" style="margin:0"><label class="form-label">Mapel</label><input type="text" id="jad-mapel" class="form-control" placeholder="Matematika"></div>
                 <button class="btn-simpan bg-green" onclick="simpanJadwal()" id="btn-jad-simpan" style="margin:0; width:auto;"><i class="fas fa-plus"></i></button>
             </div>
         </div>

         <div class="form-card" style="margin-top:15px;">
             <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                 <h4 style="margin:0; color:#007bff;" class="btn-print-hide">Daftar Jadwal Mengajar</h4>
                 <button class="btn-simpan bg-dark btn-print-hide" onclick="window.print()" style="width:auto; font-size:12px; padding:8px 15px;"><i class="fas fa-print"></i> CETAK JADWAL</button>
             </div>

             <div class="doc-header">
                <h3>JADWAL PELAJARAN GURU</h3>
                <p>Tahun Ajaran: <span id="jad-tahun-cetak">2025/2026</span></p>
             </div>

             <div id="loader-jadwal" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
             
             <div style="overflow-x:auto;">
                 <table class="doc-table" style="width:100%">
                    <thead>
                       <tr style="background:#f8f9fa;">
                          <th width="5%">No</th>
                          <th width="10%">Hari</th>
                          <th width="8%">Jam Ke</th>
                          <th width="15%">Waktu</th>
                          <th width="10%">Kelas</th>
                          <th>Mata Pelajaran</th>
                          <th width="15%" class="btn-print-hide">Aksi</th>
                       </tr>
                    </thead>
                    <tbody id="tabel-jadwal-body">
                       </tbody>
                 </table>
             </div>
             
             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="jad-kepsek">...</p><p>NIP. <span id="jad-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="jad-kota">...</span>, <span id="jad-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="jad-guru">...</p><p>NIP. <span id="jad-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>

      <div id="page-murid" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üë• Data Peserta Didik</h3>
         
         <div class="form-card btn-print-hide" style="background:#e0f7fa;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#006064;">Formulir Siswa</h4>
                <button class="btn-mini bg-red" id="btn-mur-batal" onclick="resetFormMurid()" style="display:none;">Batal Edit</button>
             </div>
             
             <input type="hidden" id="mur-rowIdx">
             <input type="hidden" id="mur-oldFotoId">

             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                 <div>
                     <div class="form-group"><label class="form-label">Nama Lengkap</label><input type="text" id="mur-nama" class="form-control"></div>
                     <div class="form-group"><label class="form-label">NIS / NISN</label><input type="text" id="mur-nis" class="form-control"></div>
                     <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                         <div class="form-group"><label class="form-label">L/P</label><select id="mur-jk" class="form-control"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
                         <div class="form-group"><label class="form-label">Kelas</label><input type="text" id="mur-kelas" class="form-control" placeholder="7A"></div>
                     </div>
                     <div class="form-group"><label class="form-label">Status</label><select id="mur-status" class="form-control"><option value="Aktif">Aktif</option><option value="Pindah">Pindah</option><option value="Keluar">Keluar</option></select></div>
                 </div>
                 
                 <div style="text-align:center;">
                     <label class="form-label">Foto Siswa (Opsional)</label>
                     <div style="border:2px dashed #ccc; padding:10px; border-radius:10px; margin-bottom:10px; background:white;">
                         <img id="preview-foto" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width:100px; height:100px; object-fit:cover; border-radius:50%;">
                         <br><br>
                         <input type="file" id="mur-foto" accept="image/*" onchange="previewImage(this)" style="font-size:11px;">
                     </div>
                     <p style="font-size:10px; color:#666;">*Maksimal 2MB. Format JPG/PNG.</p>
                 </div>
             </div>
             
             <div style="text-align:right; margin-top:10px;">
                 <button class="btn-simpan bg-teal" onclick="prosesSimpanMurid()" id="btn-mur-simpan" style="width:auto; padding:10px 30px;"><i class="fas fa-save"></i> SIMPAN DATA</button>
             </div>
         </div>

         <div class="form-card" style="margin-top:15px;">
             <h4 style="margin:0 0 15px 0; color:#007bff; border-bottom:1px solid #eee;">Direktori Siswa</h4>
             
             <input type="text" id="cari-siswa" onkeyup="filterTabelSiswa()" placeholder="Cari nama siswa..." class="form-control" style="margin-bottom:15px; border:1px solid #007bff;">

             <div id="loader-murid" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
             
             <div id="daftar-siswa-container"></div>
         </div>
      </div>

      <div id="page-presensi" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üìã Presensi Siswa</h3>
         
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabPresensi('input')" id="tab-pres-input">üìù Input / Edit Absensi</button>
            <button class="tab-btn" onclick="gantiTabPresensi('rekap')" id="tab-pres-rekap">üìä Rekap & Cetak</button>
         </div>

         <div id="view-presensi-input">
             <div class="form-card btn-print-hide" style="background:#e0f2f1;">
                 <h4 style="margin:0 0 10px 0; color:#00695c;">Konfigurasi Kelas</h4>
                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                     <div class="form-group">
                        <label class="form-label">Tanggal</label>
                        <input type="date" id="pres-tgl" class="form-control" onchange="cekEditMode()">
                     </div>
                     <div class="form-group">
                        <label class="form-label">Kelas</label>
                        <select id="pres-kelas" class="form-control" onchange="cekEditMode()">
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <label class="form-label">Mata Pelajaran</label>
                        <input type="text" id="pres-mapel" class="form-control" placeholder="Matematika" onchange="cekEditMode()">
                     </div>
                 </div>
                 <div style="text-align:right;">
                    <button class="btn-mini bg-blue" onclick="loadSiswaPresensi()">
                       <i class="fas fa-sync"></i> MUAT DATA SISWA
                    </button>
                 </div>
             </div>

             <div class="form-card">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                     <h4 style="margin:0; color:#007bff;" id="judul-tabel-presensi">Daftar Kehadiran</h4>
                     <div style="font-size:10px; color:#666;">*Pastikan Tanggal & Kelas benar sebelum simpan</div>
                 </div>
                 
                 <div id="loader-presensi" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
                 
                 <div style="overflow-x:auto;">
                     <table class="doc-table" style="width:100%">
                        <thead>
                           <tr style="background:#f8f9fa;">
                              <th width="5%">No</th>
                              <th width="35%">Nama Siswa</th>
                              <th width="30%" style="text-align:center;">Status</th>
                              <th>Keterangan</th>
                           </tr>
                        </thead>
                        <tbody id="tabel-presensi-body">
                           <tr><td colspan="4" align="center" style="padding:20px; color:#999;">Pilih Tanggal & Kelas, lalu klik <b>MUAT DATA SISWA</b>.</td></tr>
                        </tbody>
                     </table>
                 </div>
                 
                 <div style="text-align:right; margin-top:20px;">
                     <button class="btn-simpan bg-green" onclick="simpanPresensi()" id="btn-pres-simpan"><i class="fas fa-save"></i> SIMPAN KE DB</button>
                 </div>
             </div>
         </div>

         <div id="view-presensi-rekap" style="display:none;">
             <div class="form-card btn-print-hide">
                 <h4 style="margin:0 0 10px 0; color:#00695c;">Filter Laporan Absensi</h4>
                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <div class="form-group" style="margin:0"><label class="form-label">Kelas</label><select id="rekap-kelas" class="form-control"><option value="">-- Pilih --</option></select></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Dari Tanggal</label><input type="date" id="rekap-mulai" class="form-control"></div>
                    <div class="form-group" style="margin:0"><label class="form-label">Sampai Tanggal</label><input type="date" id="rekap-akhir" class="form-control"></div>
                    <button class="btn-simpan bg-orange" onclick="loadRekapPresensi()" style="margin:0; width:auto;"><i class="fas fa-search"></i> TAMPILKAN</button>
                 </div>
             </div>

             <div id="area-cetak-rekap" class="form-card">
                 <div class="doc-header">
                    <h3>REKAPITULASI PRESENSI SISWA</h3>
                    <p>Kelas: <span id="cetak-rekap-kelas">...</span> | Periode: <span id="cetak-rekap-periode">...</span></p>
                 </div>
                 
                 <div style="text-align:right; margin-bottom:10px;" class="btn-print-hide">
                     <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; padding:8px 15px; font-size:12px;"><i class="fas fa-print"></i> CETAK LAPORAN</button>
                 </div>

                 <div id="loader-rekap" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Menghitung...</div>
                 
                 <div style="overflow-x:auto;">
                     <table class="doc-table" style="width:100%">
                        <thead>
                           <tr style="background:#f8f9fa;">
                              <th width="5%" rowspan="2">No</th>
                              <th rowspan="2">Nama Siswa</th>
                              <th colspan="4" style="text-align:center;">Jumlah Kehadiran</th>
                              <th rowspan="2" width="10%">% Hadir</th>
                           </tr>
                           <tr style="background:#eee;">
                              <th width="8%" align="center">H</th>
                              <th width="8%" align="center">S</th>
                              <th width="8%" align="center">I</th>
                              <th width="8%" align="center">A</th>
                           </tr>
                        </thead>
                        <tbody id="tabel-rekap-body">
                           <tr><td colspan="7" align="center" style="padding:20px; color:#999;">Silakan filter data di atas.</td></tr>
                        </tbody>
                     </table>
                 </div>

                 <table class="signature-table" border="0" style="margin-top:30px;">
                    <tr>
                       <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="pres-kepsek">...</p><p>NIP. <span id="pres-nip-kepsek"></span></p></td>
                       <td width="50%"><p><span id="pres-kota">...</span>, <span id="pres-tgl-ttd">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="pres-guru">...</p><p>NIP. <span id="pres-nip"></span></p></td>
                    </tr>
                 </table>
             </div>
         </div>
      </div>

      <div id="page-perangkat" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3" id="judul-perangkat">üìÇ Perangkat Ajar</h3>
         <div class="form-card">
             <div id="perangkat-container">Memuat Data...</div>
         </div>
      </div>
      <div id="page-cp" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üéØ Capaian Pembelajaran (CP)</h3>
         
         <div class="form-card btn-print-hide" style="background:#f3e5f5;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#6a1b9a;">Kelola CP</h4>
                <button class="btn-mini bg-red" id="btn-cp-batal" onclick="resetFormCP()" style="display:none;">Batal Edit</button>
             </div>
             
             <input type="hidden" id="cp-rowIdx">
             
             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Elemen</label>
                    <input type="text" id="cp-elemen" class="form-control" placeholder="Contoh: Bilangan, Aljabar">
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Fase</label>
                    <select id="cp-fase" class="form-control">
                        <option value="Fase D">Fase D (SMP Kelas 7-9)</option>
                        <option value="Fase A">Fase A (SD 1-2)</option>
                        <option value="Fase B">Fase B (SD 3-4)</option>
                        <option value="Fase C">Fase C (SD 5-6)</option>
                    </select>
                 </div>
             </div>
             
             <div class="form-group">
                <label class="form-label">Isi Capaian Pembelajaran</label>
                <textarea id="cp-isi" class="form-control" rows="4" placeholder="Ketik isi CP di sini..."></textarea>
             </div>
             
             <div style="text-align:right;">
                 <button class="btn-simpan bg-purple" onclick="simpanCP()" id="btn-cp-simpan" style="width:auto; padding:10px 30px;"><i class="fas fa-save"></i> SIMPAN CP</button>
             </div>
         </div>

         <div class="form-card" style="margin-top:15px;">
             <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                 <h4 style="margin:0; color:#007bff;" class="btn-print-hide">Daftar Capaian Pembelajaran</h4>
                 <button class="btn-simpan bg-dark btn-print-hide" onclick="window.print()" style="width:auto; font-size:12px; padding:8px 15px;"><i class="fas fa-print"></i> CETAK DOKUMEN</button>
             </div>

             <div class="doc-header">
                <h3>CAPAIAN PEMBELAJARAN (CP)</h3>
                <h4 style="margin:5px 0;">MATA PELAJARAN: <span id="cp-mapel-head">...</span></h4>
                <p>Tahun Ajaran: <span id="cp-tahun">...</span></p>
             </div>

             <div id="loader-cp" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
             
             <div style="overflow-x:auto;">
                 <table class="doc-table" style="width:100%">
                    <thead>
                       <tr style="background:#f8f9fa;">
                          <th width="5%">No</th>
                          <th width="15%">Elemen</th>
                          <th width="10%">Fase</th>
                          <th>Isi Capaian Pembelajaran</th>
                          <th width="15%" class="btn-print-hide">Aksi</th>
                       </tr>
                    </thead>
                    <tbody id="tabel-cp-body"></tbody>
                 </table>
             </div>

             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="cp-kepsek">...</p><p>NIP. <span id="cp-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="cp-kota">...</span>, <span id="cp-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="cp-guru">...</p><p>NIP. <span id="cp-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>
      <div id="page-tp" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üéØ Tujuan Pembelajaran (TP)</h3>
         
         <div class="form-card btn-print-hide" style="background:#f3e5f5;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:#6a1b9a;">Susun TP Baru</h4>
                <button class="btn-mini bg-red" id="btn-tp-batal" onclick="resetFormTP()" style="display:none;">Batal Edit</button>
             </div>
             
             <input type="hidden" id="tp-rowIdx">
             
             <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Kelas / Semester</label>
                    <select id="tp-kelas" class="form-control">
                        <option value="VII/1">Kelas VII - Sem 1</option>
                        <option value="VII/2">Kelas VII - Sem 2</option>
                        <option value="VIII/1">Kelas VIII - Sem 1</option>
                        <option value="VIII/2">Kelas VIII - Sem 2</option>
                        <option value="IX/1">Kelas IX - Sem 1</option>
                        <option value="IX/2">Kelas IX - Sem 2</option>
                    </select>
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">No. Alur (Urutan)</label>
                    <input type="number" id="tp-alur" class="form-control" placeholder="1, 2, 3...">
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Alokasi Waktu</label>
                    <input type="text" id="tp-alokasi" class="form-control" placeholder="Contoh: 2 JP">
                 </div>
             </div>
             
             <div class="form-group">
                <label class="form-label">Lingkup Materi</label>
                <input type="text" id="tp-materi" class="form-control" placeholder="Contoh: Bilangan Bulat">
             </div>

             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Tujuan Pembelajaran (TP)</label>
                    <textarea id="tp-tujuan" class="form-control" rows="4" placeholder="Peserta didik mampu..."></textarea>
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Pemahaman Bermakna</label>
                    <textarea id="tp-pemahaman" class="form-control" rows="4" placeholder="Manfaat dalam kehidupan nyata..."></textarea>
                 </div>
             </div>

             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Rencana Asesmen</label>
                    <textarea id="tp-asesmen" class="form-control" rows="2" placeholder="Formatif: Latihan... Sumatif: Tes..."></textarea>
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Metode / Model</label>
                    <textarea id="tp-metode" class="form-control" rows="2" placeholder="Diskusi, PBL, dll"></textarea>
                 </div>
             </div>
             
             <div style="text-align:right; margin-top:15px;">
                 <button class="btn-simpan bg-purple" onclick="simpanTP()" id="btn-tp-simpan" style="width:auto; padding:10px 30px;"><i class="fas fa-save"></i> SIMPAN TP</button>
             </div>
         </div>

         <div class="form-card" style="margin-top:15px;">
             <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                 <div style="display:flex; align-items:center; gap:10px;">
                     <h4 style="margin:0; color:#007bff;" class="btn-print-hide">Daftar TP</h4>
                     <select id="filter-tp-kelas" class="form-control btn-print-hide" style="width:150px; height:35px; padding:0 10px;" onchange="loadTP()">
                        <option value="">Semua Kelas</option>
                        <option value="VII/1">VII - Sem 1</option>
                        <option value="VII/2">VII - Sem 2</option>
                        <option value="VIII/1">VIII - Sem 1</option>
                        <option value="VIII/2">VIII - Sem 2</option>
                        <option value="IX/1">IX - Sem 1</option>
                        <option value="IX/2">IX - Sem 2</option>
                     </select>
                 </div>
                 <button class="btn-simpan bg-dark btn-print-hide" onclick="window.print()" style="width:auto; font-size:12px; padding:8px 15px;"><i class="fas fa-print"></i> CETAK</button>
             </div>

             <div class="doc-header">
                <h3>TUJUAN PEMBELAJARAN (TP)</h3>
                <h4 style="margin:5px 0;">MATA PELAJARAN: <span id="tp-mapel-head">...</span></h4>
                <p>Kelas/Semester: <span id="tp-kelas-head">...</span> | Tahun: <span id="tp-tahun">...</span></p>
             </div>

             <div id="loader-tp" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
             
             <div style="overflow-x:auto;">
                 <table class="doc-table" style="width:100%">
                    <thead>
                       <tr style="background:#f8f9fa;">
                          <th width="5%">Alur</th>
                          <th width="8%">Waktu</th>
                          <th width="15%">Materi</th>
                          <th>Tujuan Pembelajaran (TP)</th>
                          <th width="15%">Asesmen</th>
                          <th width="10%" class="btn-print-hide">Aksi</th>
                       </tr>
                    </thead>
                    <tbody id="tabel-tp-body"></tbody>
                 </table>
             </div>

             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="tp-kepsek">...</p><p>NIP. <span id="tp-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="tp-kota">...</span>, <span id="tp-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="tp-guru">...</p><p>NIP. <span id="tp-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>
      <div id="page-atp" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üìà Alur Tujuan Pembelajaran (ATP)</h3>
         
         <div class="form-card btn-print-hide" style="background:#e1bee7;">
             <h4 style="margin:0 0 10px 0; color:#4a148c;">Generator Dokumen ATP</h4>
             <p style="font-size:11px; margin-bottom:10px;">Sistem akan menyusun ATP otomatis berdasarkan data CP dan TP yang telah Anda input.</p>
             
             <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Pilih Fase CP</label>
                    <select id="atp-fase" class="form-control">
                        <option value="Fase D">Fase D (SMP Kelas 7-9)</option>
                        <option value="Fase A">Fase A (SD 1-2)</option>
                        <option value="Fase B">Fase B (SD 3-4)</option>
                        <option value="Fase C">Fase C (SD 5-6)</option>
                    </select>
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Pilih Kelas / Semester (TP)</label>
                    <select id="atp-kelas" class="form-control">
                        <option value="VII/1">Kelas VII - Sem 1</option>
                        <option value="VII/2">Kelas VII - Sem 2</option>
                        <option value="VIII/1">Kelas VIII - Sem 1</option>
                        <option value="VIII/2">Kelas VIII - Sem 2</option>
                        <option value="IX/1">Kelas IX - Sem 1</option>
                        <option value="IX/2">Kelas IX - Sem 2</option>
                    </select>
                 </div>
                 <button class="btn-simpan bg-purple" onclick="generateATP()" style="margin:0; width:auto;"><i class="fas fa-magic"></i> SUSUN ATP</button>
             </div>
         </div>

         <div id="atp-preview-area" class="form-card" style="margin-top:15px; display:none;">
             <div style="text-align:right; margin-bottom:10px;" class="btn-print-hide">
                 <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; padding:8px 15px; font-size:12px;"><i class="fas fa-print"></i> CETAK DOKUMEN</button>
             </div>

             <div class="doc-header" style="display:block !important; border-bottom:3px double #000;">
                <h3 style="margin-bottom:5px;">ALUR TUJUAN PEMBELAJARAN (ATP)</h3>
                <h4 style="margin:0;">TAHUN PELAJARAN <span id="atp-tahun">...</span></h4>
             </div>
             
             <table style="width:100%; font-size:12px; margin-bottom:20px; font-weight:bold; border-bottom:1px solid #000; padding-bottom:10px;">
                <tr><td width="20%">Satuan Pendidikan</td><td>: <span id="atp-sekolah">...</span></td><td width="15%">Fase</td><td>: <span id="atp-fase-view">...</span></td></tr>
                <tr><td>Mata Pelajaran</td><td>: <span id="atp-mapel">...</span></td><td>Kelas/Sem</td><td>: <span id="atp-kelas-view">...</span></td></tr>
                <tr><td>Guru Mapel</td><td>: <span id="atp-guru-head">...</span></td><td></td><td></td></tr>
             </table>

             <div id="loader-atp" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Menyusun Data...</div>
             
             <div id="konten-atp">
                 <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px; margin-top:0;">A. CAPAIAN PEMBELAJARAN (CP)</h4>
                 <div id="list-cp-atp" style="margin-bottom:20px; font-size:12px; text-align:justify;"></div>

                 <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px;">B. ALUR TUJUAN PEMBELAJARAN</h4>
                 <table class="doc-table" style="width:100%">
                    <thead>
                       <tr style="background:#f0f0f0;">
                          <th width="5%">No. Alur</th>
                          <th width="20%">Lingkup Materi</th>
                          <th>Tujuan Pembelajaran (TP)</th>
                          <th width="10%">Alokasi Waktu</th>
                       </tr>
                    </thead>
                    <tbody id="tabel-atp-body"></tbody>
                 </table>
             </div>

             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="atp-kepsek">...</p><p>NIP. <span id="atp-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="atp-kota">...</span>, <span id="atp-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="atp-guru">...</p><p>NIP. <span id="atp-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>
      <div id="page-modul" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üìò Modul Ajar / RPP</h3>
         
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabModul('data')" id="tab-mod-data">üìÇ Data Modul</button>
            <button class="tab-btn" onclick="gantiTabModul('input')" id="tab-mod-input">üìù Input Modul Baru</button>
         </div>

         <div id="view-modul-data">
             <div class="form-card">
                 <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                     <h4 style="margin:0; color:#007bff;">Bank Modul Ajar</h4>
                     <select id="filter-modul-kelas" class="form-control" style="width:150px; height:35px;" onchange="loadModul()">
                        <option value="">Semua Kelas</option>
                        <option value="VII">Kelas VII</option>
                        <option value="VIII">Kelas VIII</option>
                        <option value="IX">Kelas IX</option>
                     </select>
                 </div>
                 <div id="loader-modul" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
                 <div style="overflow-x:auto;">
                     <table class="doc-table" style="width:100%">
                        <thead>
                           <tr style="background:#f8f9fa;">
                              <th width="5%">No</th>
                              <th width="10%">Kelas/Fase</th>
                              <th>Topik / Materi Pokok</th>
                              <th width="15%">Alokasi</th>
                              <th width="15%" class="btn-print-hide">Aksi</th>
                           </tr>
                        </thead>
                        <tbody id="tabel-modul-body"></tbody>
                     </table>
                 </div>
             </div>
         </div>

         <div id="view-modul-input" style="display:none;">
             <div class="form-card btn-print-hide" style="background:#fff;">
                 <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h4 style="color:#6a1b9a; margin:0;">Penyusunan Modul Ajar</h4>
                    <button class="btn-mini bg-red" onclick="resetFormModul()" style="display:none;" id="btn-mod-batal">Batal Edit</button>
                 </div>
                 <input type="hidden" id="mod-rowIdx">

                 <h5 style="background:#eee; padding:5px; border-left:4px solid #6a1b9a;">A. IDENTITAS MODUL</h5>
                 <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:10px; margin-bottom:10px;">
                     <div class="form-group"><label class="form-label">Fase</label><select id="mod-fase" class="form-control"><option>D</option><option>A</option><option>B</option><option>C</option></select></div>
                     <div class="form-group"><label class="form-label">Kelas</label><select id="mod-kelas" class="form-control" onchange="loadOpsiTPModul()"><option value="">Pilih</option><option value="VII">VII</option><option value="VIII">VIII</option><option value="IX">IX</option></select></div>
                     <div class="form-group"><label class="form-label">Materi Pokok</label><input type="text" id="mod-materi" class="form-control" placeholder="Judul Besar Materi"></div>
                 </div>
                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                     <div class="form-group"><label class="form-label">Alokasi Waktu</label><input type="text" id="mod-alokasi" class="form-control" placeholder="Cth: 2 JP (80 Menit)"></div>
                     <div class="form-group"><label class="form-label">Profil Pelajar Pancasila</label><input type="text" id="mod-profil" class="form-control" placeholder="Mandiri, Bernalar Kritis..."></div>
                 </div>
                 <div class="form-group"><label class="form-label">Sarana & Prasarana / Media</label><textarea id="mod-sarana" class="form-control" rows="1" placeholder="Laptop, LCD, Buku Paket..."></textarea></div>

                 <h5 style="background:#eee; padding:5px; border-left:4px solid #6a1b9a;">B. KOMPETENSI INTI</h5>
                 <div class="form-group">
                    <label class="form-label">Tujuan Pembelajaran (Pilih TP dari Database atau Ketik Manual)</label>
                    <input list="list-tp-modul" id="mod-tp" class="form-control" placeholder="Ketik atau pilih TP...">
                    <datalist id="list-tp-modul"></datalist>
                 </div>
                 <div class="form-group"><label class="form-label">Pertanyaan Pemantik</label><textarea id="mod-pemantik" class="form-control" rows="1"></textarea></div>

                 <h5 style="background:#eee; padding:5px; border-left:4px solid #6a1b9a;">C. LANGKAH PEMBELAJARAN</h5>
                 <div id="container-kegiatan">
                     </div>
                 <button class="btn-mini bg-blue" onclick="tambahPertemuan()"><i class="fas fa-plus-circle"></i> Tambah Pertemuan Lain</button>

                 <h5 style="background:#eee; padding:5px; border-left:4px solid #6a1b9a; margin-top:15px;">D. ASESMEN & LAMPIRAN</h5>
                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                     <div class="form-group"><label class="form-label">Asesmen (Formatif/Sumatif)</label><textarea id="mod-asesmen" class="form-control" rows="2" placeholder="Sikap: Observasi, Pengetahuan: Tes Tulis..."></textarea></div>
                     <div class="form-group"><label class="form-label">Lampiran (LKPD / Bahan Bacaan)</label><textarea id="mod-lampiran" class="form-control" rows="2" placeholder="Terlampir LKPD 1..."></textarea></div>
                 </div>

                 <div style="text-align:right; margin-top:20px;">
                     <button class="btn-simpan bg-purple" onclick="simpanModul()" id="btn-mod-simpan" style="width:auto; padding:12px 30px;"><i class="fas fa-save"></i> SIMPAN MODUL</button>
                 </div>
             </div>
         </div>

         <div id="view-modul-cetak" class="form-card" style="display:none; margin-top:15px;">
             <div style="text-align:right; margin-bottom:10px;" class="btn-print-hide">
                 <button class="btn-simpan bg-orange" onclick="gantiTabModul('data')" style="width:auto; margin-right:10px;">Tutup</button>
                 <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto;"><i class="fas fa-print"></i> CETAK MODUL</button>
             </div>

             <div class="doc-header" style="display:block !important;">
                <h3>MODUL AJAR / RPP</h3>
                <h4 style="margin:5px 0;">MATEMATIKA FASE <span id="cmod-fase">D</span></h4>
             </div>
             
             <div style="margin-bottom:15px; border:1px solid #000; padding:10px;">
                 <table style="width:100%; font-size:12px; font-weight:bold;">
                    <tr><td width="20%">Nama Penyusun</td><td>: <span id="cmod-guru">...</span></td><td width="15%">Kelas</td><td>: <span id="cmod-kelas">...</span></td></tr>
                    <tr><td>Satuan Pendidikan</td><td>: <span id="cmod-sekolah">...</span></td><td>Alokasi Waktu</td><td>: <span id="cmod-alokasi">...</span></td></tr>
                    <tr><td>Tahun Pelajaran</td><td>: <span id="cmod-tahun">...</span></td><td>Materi Pokok</td><td>: <span id="cmod-materi">...</span></td></tr>
                 </table>
             </div>

             <div id="konten-cetak-modul">
                 </div>

             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="cmod-kepsek">...</p><p>NIP. <span id="cmod-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="cmod-kota">...</span>, <span id="cmod-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="cmod-guru-ttd">...</p><p>NIP. <span id="cmod-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>
      <div id="page-prota" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üìÖ Program Tahunan (PROTA)</h3>
         
         <div class="form-card btn-print-hide" style="background:#fff3e0;">
             <h4 style="margin:0 0 10px 0; color:#e65100;">Generator Prota Otomatis</h4>
             <p style="font-size:11px; margin-bottom:10px;">Sistem akan menyusun Program Tahunan berdasarkan data TP Semester 1 & 2 yang telah diinput.</p>
             
             <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end;">
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Fase</label>
                    <select id="prota-fase" class="form-control">
                        <option value="Fase D">Fase D (SMP 7-9)</option>
                        <option value="Fase A">Fase A (SD 1-2)</option>
                        <option value="Fase B">Fase B (SD 3-4)</option>
                        <option value="Fase C">Fase C (SD 5-6)</option>
                    </select>
                 </div>
                 <div class="form-group" style="margin:0">
                    <label class="form-label">Kelas</label>
                    <select id="prota-kelas" class="form-control">
                        <option value="VII">Kelas VII</option>
                        <option value="VIII">Kelas VIII</option>
                        <option value="IX">Kelas IX</option>
                    </select>
                 </div>
                 <button class="btn-simpan bg-orange" onclick="generateProta()" style="margin:0; width:auto;"><i class="fas fa-magic"></i> SUSUN PROTA</button>
             </div>
         </div>

         <div id="prota-preview" class="form-card" style="margin-top:15px; display:none;">
             <div style="text-align:right; margin-bottom:10px;" class="btn-print-hide">
                 <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; padding:8px 15px; font-size:12px;"><i class="fas fa-print"></i> CETAK DOKUMEN</button>
             </div>

             <div class="doc-header" style="display:block !important; border-bottom:3px double #000;">
                <h3 style="margin-bottom:5px;">PROGRAM TAHUNAN (PROTA)</h3>
                <h4 style="margin:0;">TAHUN PELAJARAN <span id="prota-tahun">...</span></h4>
             </div>
             
             <table style="width:100%; font-size:12px; margin-bottom:20px; font-weight:bold; border-bottom:1px solid #000; padding-bottom:10px;">
                <tr><td width="20%">Satuan Pendidikan</td><td>: <span id="prota-sekolah">...</span></td><td width="15%">Fase</td><td>: <span id="prota-fase-view">...</span></td></tr>
                <tr><td>Mata Pelajaran</td><td>: <span id="prota-mapel">...</span></td><td>Kelas</td><td>: <span id="prota-kelas-view">...</span></td></tr>
                <tr><td>Guru Mapel</td><td>: <span id="prota-guru-head">...</span></td><td></td><td></td></tr>
             </table>

             <div id="loader-prota" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Menyusun Data...</div>
             
             <div id="konten-prota">
                 <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px; margin-top:0;">A. CAPAIAN PEMBELAJARAN</h4>
                 <div id="list-cp-prota" style="margin-bottom:20px; font-size:12px; text-align:justify;"></div>

                 <h4 style="border-bottom:1px solid #ccc; padding-bottom:5px;">B. ALOKASI WAKTU</h4>
                 <table class="doc-table" style="width:100%">
                    <thead>
                       <tr style="background:#f0f0f0;">
                          <th width="5%">Smt</th>
                          <th width="5%">No</th>
                          <th width="30%">Materi Pokok</th>
                          <th>Tujuan Pembelajaran (TP)</th>
                          <th width="10%">Waktu</th>
                       </tr>
                    </thead>
                    <tbody id="tabel-prota-body"></tbody>
                 </table>
             </div>

             <table class="signature-table" border="0" style="margin-top:30px;">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="prota-kepsek">...</p><p>NIP. <span id="prota-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="prota-kota">...</span>, <span id="prota-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="prota-guru">...</p><p>NIP. <span id="prota-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>
      <div id="page-prosem" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üìÖ Program Semester (PROSEM)</h3>
         
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabProsem('data')" id="tab-pros-data">üìÇ Data Tersimpan</button>
            <button class="tab-btn" onclick="gantiTabProsem('input')" id="tab-pros-input">üìù Buat Prosem Baru</button>
         </div>

         <div id="view-pros-data">
             <div class="form-card">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                     <h4 style="margin:0; color:#007bff;">Arsip Program Semester</h4>
                     <div style="display:flex; gap:10px;">
                        <select id="filter-pros-kelas" class="form-control" style="width:100px;" onchange="loadDataProsem()">
                            <option value="VII">VII</option><option value="VIII">VIII</option><option value="IX">IX</option>
                        </select>
                        <select id="filter-pros-sem" class="form-control" style="width:100px;" onchange="loadDataProsem()">
                            <option value="1">Sem 1</option><option value="2">Sem 2</option>
                        </select>
                     </div>
                 </div>
                 <div id="loader-pros-data" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
                 <div id="container-list-prosem"></div>
             </div>
         </div>

         <div id="view-pros-input" style="display:none;">
             <div class="form-card btn-print-hide" style="background:#fff8e1;">
                 <h4 style="margin:0 0 10px 0; color:#ff6f00;">Editor Matriks Prosem</h4>
                 <input type="hidden" id="pros-rowIdx">
                 
                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:15px;">
                     <div class="form-group" style="margin:0"><label class="form-label">Fase</label><select id="pros-fase" class="form-control"><option>D</option><option>A</option><option>B</option><option>C</option></select></div>
                     <div class="form-group" style="margin:0"><label class="form-label">Kelas</label><select id="pros-kelas" class="form-control"><option value="VII">VII</option><option value="VIII">VIII</option><option value="IX">IX</option></select></div>
                     <div class="form-group" style="margin:0"><label class="form-label">Semester</label><select id="pros-smt" class="form-control"><option value="1">1 (Ganjil)</option><option value="2">2 (Genap)</option></select></div>
                     <div class="form-group" style="margin:0"><label class="form-label">Tahun</label><input type="text" id="pros-tahun" class="form-control" value="2025/2026"></div>
                     <button class="btn-simpan bg-blue" onclick="loadTPForProsem()" style="width:auto; margin:0;"><i class="fas fa-sync"></i> GENERATE MATRIKS</button>
                 </div>
                 
                 <div id="loader-pros-input" style="text-align:center; display:none; margin:20px;"><i class="fas fa-spinner fa-spin"></i> Mengambil Data TP...</div>
             </div>

             <div id="area-kerja-prosem" class="form-card" style="display:none; margin-top:15px;">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;" class="btn-print-hide">
                     <p style="font-size:11px; color:#666; margin:0;">*Klik kotak kecil untuk menandai (arsir) minggu efektif.</p>
                     <div>
                        <button class="btn-simpan bg-red" onclick="resetFormProsem()" style="width:auto; margin-right:5px;">Batal</button>
                        <button class="btn-simpan bg-green" onclick="simpanProsem()" id="btn-pros-simpan" style="width:auto;"><i class="fas fa-save"></i> SIMPAN PROSEM</button>
                        <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto;"><i class="fas fa-print"></i> CETAK</button>
                     </div>
                 </div>

                 <div class="doc-header">
                    <h3>PROGRAM SEMESTER (PROSEM)</h3>
                    <p>Tahun Pelajaran: <span id="cpros-tahun">...</span></p>
                 </div>
                 <div class="doc-header" style="border:none; text-align:left; margin-bottom:10px; font-size:11px; font-weight:bold;">
                    Satuan Pendidikan: <span id="cpros-sekolah">...</span><br>
                    Mata Pelajaran: <span id="cpros-mapel">...</span><br>
                    Kelas / Semester: <span id="cpros-kelas">...</span>
                 </div>

                 <div style="overflow-x:auto;">
                     <table class="doc-table" style="width:100%; font-size:10px;">
                        <thead id="pros-thead"></thead>
                        <tbody id="pros-tbody"></tbody>
                     </table>
                 </div>

                 <table class="signature-table" border="0" style="margin-top:30px;">
                    <tr>
                       <td width="50%"><p>Mengetahui,<br>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="cpros-kepsek">...</p><p>NIP. <span id="cpros-nip-kepsek"></span></p></td>
                       <td width="50%"><p><span id="cpros-kota">...</span>, <span id="cpros-tgl">...</span><br>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="cpros-guru">...</p><p>NIP. <span id="cpros-nip"></span></p></td>
                    </tr>
                 </table>
             </div>
         </div>
      </div>

      <style>
        .cell-check { cursor: pointer; text-align: center; font-size: 9px; }
        .cell-check:hover { background-color: #f0f0f0; }
        .is-checked { background-color: #28a745 !important; color: white; font-weight: bold; }
        /* Saat Print, warna background harus muncul */
        @media print {
            .is-checked { background-color: #333 !important; -webkit-print-color-adjust: exact; }
            @page { size: landscape; margin: 10px; }
        }
      </style>
      <div id="page-kktp" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back btn-print-hide"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3 btn-print-hide">üìà Kriteria Ketercapaian (KKTP)</h3>
         
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabKKTP('data')" id="tab-kktp-data">üìÇ Data KKTP</button>
            <button class="tab-btn" onclick="gantiTabKKTP('input')" id="tab-kktp-input">üìù Input Baru</button>
         </div>

         <div id="view-kktp-data">
             <div class="form-card">
                 <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                     <h4 style="margin:0; color:#007bff;" class="btn-print-hide">Arsip KKTP</h4>
                     <div style="display:flex; gap:10px;" class="btn-print-hide">
                        <select id="filter-kktp-kelas" class="form-control" style="width:100px;" onchange="loadDataKKTP()">
                            <option value="VII">VII</option><option value="VIII">VIII</option><option value="IX">IX</option>
                        </select>
                        <select id="filter-kktp-sem" class="form-control" style="width:100px;" onchange="loadDataKKTP()">
                            <option value="1">Sem 1</option><option value="2">Sem 2</option>
                        </select>
                        <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; height:38px; padding:0 15px; margin:0;"><i class="fas fa-print"></i></button>
                     </div>
                 </div>

                 <div class="doc-header">
                    <h3>KRITERIA KETERCAPAIAN TUJUAN PEMBELAJARAN (KKTP)</h3>
                    <p>Tahun Pelajaran: <span id="ckktp-tahun">...</span></p>
                 </div>
                 <div class="doc-header" style="border:none; text-align:left; margin-bottom:10px; font-size:11px; font-weight:bold; display:none;" id="header-detail-kktp">
                    <table style="width:100%; border:none;">
                        <tr><td style="border:none; width:15%;">Satuan Pendidikan</td><td style="border:none;">: <span id="ckktp-sekolah">...</span></td><td style="border:none; width:15%;">Fase</td><td style="border:none;">: <span id="ckktp-fase">D</span></td></tr>
                        <tr><td style="border:none;">Mata Pelajaran</td><td style="border:none;">: <span id="ckktp-mapel">...</span></td><td style="border:none;">Kelas/Sem</td><td style="border:none;">: <span id="ckktp-kelas">...</span></td></tr>
                    </table>
                 </div>

                 <div id="loader-kktp" style="text-align:center; display:none;"><i class="fas fa-spinner fa-spin"></i> Memuat...</div>
                 
                 <div style="overflow-x:auto;">
                     <table class="doc-table" style="width:100%">
                        <thead>
                           <tr style="background:#f8f9fa;">
                              <th width="5%">No</th>
                              <th>Materi / TP</th>
                              <th width="25%">Kriteria / Deskripsi</th>
                              <th width="15%">Interval / Target</th>
                              <th width="20%">Tindak Lanjut</th>
                              <th width="10%" class="btn-print-hide">Aksi</th>
                           </tr>
                        </thead>
                        <tbody id="tabel-kktp-body"></tbody>
                     </table>
                 </div>

                 <table class="signature-table" border="0" style="margin-top:30px;">
                    <tr>
                       <td width="50%"><p>Mengetahui,<br>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="ckktp-kepsek">...</p><p>NIP. <span id="ckktp-nip-kepsek"></span></p></td>
                       <td width="50%"><p><span id="ckktp-kota">...</span>, <span id="ckktp-tgl">...</span><br>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="ckktp-guru">...</p><p>NIP. <span id="ckktp-nip"></span></p></td>
                    </tr>
                 </table>
             </div>
         </div>

         <div id="view-kktp-input" style="display:none;">
             <div class="form-card btn-print-hide" style="background:#e8eaf6;">
                 <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h4 style="color:#3f51b5; margin:0;">Formulir KKTP</h4>
                    <button class="btn-mini bg-red" onclick="resetFormKKTP()" style="display:none;" id="btn-kktp-batal">Batal Edit</button>
                 </div>
                 <input type="hidden" id="kktp-rowIdx">

                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                     <div class="form-group"><label class="form-label">Fase</label><select id="kktp-fase" class="form-control"><option>D</option><option>A</option><option>B</option><option>C</option></select></div>
                     <div class="form-group"><label class="form-label">Kelas</label><select id="kktp-kelas" class="form-control" onchange="loadTPForKKTPDropdown()"><option value="VII">VII</option><option value="VIII">VIII</option><option value="IX">IX</option></select></div>
                     <div class="form-group"><label class="form-label">Semester</label><select id="kktp-smt" class="form-control" onchange="loadTPForKKTPDropdown()"><option value="1">1 (Ganjil)</option><option value="2">2 (Genap)</option></select></div>
                 </div>

                 <div class="form-group">
                    <label class="form-label">Pilih TP (Dari Prosem)</label>
                    <div style="display:flex; gap:5px;">
                        <input list="list-tp-kktp" id="kktp-tp" class="form-control" placeholder="Ketik atau Pilih TP...">
                        <datalist id="list-tp-kktp"></datalist>
                        <button class="btn-simpan bg-blue" onclick="loadTPForKKTPDropdown()" style="width:auto; padding:5px 10px;" title="Refresh TP"><i class="fas fa-sync"></i></button>
                    </div>
                 </div>

                 <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px; margin-bottom:10px;">
                     <div class="form-group"><label class="form-label">BAB / Lingkup Materi</label><input type="text" id="kktp-bab" class="form-control" placeholder="Contoh: Bilangan"></div>
                     <div class="form-group"><label class="form-label">No. Alur</label><input type="text" id="kktp-alur" class="form-control" placeholder="1"></div>
                 </div>

                 <div class="form-group"><label class="form-label">Kriteria / Deskripsi Ketercapaian</label><textarea id="kktp-kriteria" class="form-control" rows="2" placeholder="Peserta didik mampu... (minimal 75%)"></textarea></div>

                 <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                     <div class="form-group"><label class="form-label">Interval / Kategori</label><input type="text" id="kktp-kategori" class="form-control" placeholder="Cth: 0-70 (Perlu Bimbingan), 71-100 (Mahir)"></div>
                     <div class="form-group"><label class="form-label">Tindak Lanjut</label><input type="text" id="kktp-tindak" class="form-control" placeholder="Remedial / Pengayaan"></div>
                 </div>

                 <div style="text-align:right; margin-top:20px;">
                     <button class="btn-simpan bg-indigo" onclick="simpanKKTP()" id="btn-kktp-simpan" style="width:auto; padding:12px 30px;"><i class="fas fa-save"></i> SIMPAN KKTP</button>
                 </div>
             </div>
         </div>
      </div>

      <div id="page-pas" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üíª Ujian PAS & CBT</h3>
         <div class="form-card text-center" style="padding:50px;">
             <i class="fas fa-laptop-code fa-3x mb-3" style="color:#007bff;"></i><br>
             <h4>Server Ujian Terpisah</h4>
             <p style="color:#666;">Silakan akses Aplikasi CBT Khusus untuk melaksanakan ujian.</p>
         </div>
      </div>

      <div id="page-nilai" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üìä Daftar Nilai Siswa</h3>
         <div class="form-card btn-print-hide">
            <h4 style="margin:0 0 10px 0; color:#007bff;">1. Konfigurasi Kelas & Kolom</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end; margin-bottom:15px;">
               <div class="form-group" style="margin:0;"><label class="form-label">Kelas</label><select class="form-control" id="nilai-kelas"><option value="">-- Pilih Kelas --</option></select></div>
               <div class="form-group" style="margin:0;"><label class="form-label">Semester</label><select class="form-control" id="nilai-sem"><option value="1">1 (Ganjil)</option><option value="2">2 (Genap)</option></select></div>
               <button class="btn-simpan" onclick="loadDaftarNilai()" style="height:42px; background:#17a2b8;">MUAT DATA</button>
            </div>
            <div id="panel-kontrol-nilai" style="display:none; border-top:1px dashed #ccc; padding-top:10px;">
               <small style="font-weight:bold; color:#555;">Tambah Item Penilaian:</small><br>
               <button class="btn-mini bg-blue" onclick="tambahMateri()">+ Materi Formatif</button>
               <button class="btn-mini bg-orange" onclick="tambahSumatif()">+ Kolom Sumatif</button>
               <span style="float:right;">
                  <button class="btn-simpan" onclick="prosesSimpanNilai()" style="width:auto; padding:5px 15px; font-size:12px;"><i class="fas fa-save"></i> SIMPAN SEMUA</button>
                  <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; padding:5px 15px; font-size:12px;"><i class="fas fa-print"></i> CETAK</button>
               </span>
            </div>
         </div>
         <div id="nilai-container" style="overflow-x:auto; background:white; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); min-height:300px;">
            <div style="text-align:center; padding:30px; color:#aaa;">Silakan pilih Kelas & Semester lalu klik tombol <b>MUAT DATA</b> di atas.</div>
         </div>
         <div id="cetak-nilai-footer" style="display:none;">
             <table class="signature-table" border="0">
                <tr>
                   <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="nil-kepsek">...</p><p>NIP. <span id="nil-nip-kepsek"></span></p></td>
                   <td width="50%"><p><span id="nil-kota">...</span>, <span id="nil-tanggal">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="nil-guru">...</p><p>NIP. <span id="nil-nip"></span></p></td>
                </tr>
             </table>
         </div>
      </div>

      <div id="page-agenda" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üìù Agenda & Jurnal Mengajar</h3>
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabAgenda('input')" id="tab-agn-input">Input Harian</button>
            <button class="tab-btn" onclick="gantiTabAgenda('riwayat')" id="tab-agn-riwayat">Riwayat & Laporan Bulanan</button>
         </div>
         <div id="agenda-input-view">
             <div class="form-card btn-print-hide">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:15px;">
                   <h4 style="margin:0; color:#007bff;">Formulir Agenda</h4>
                   <button class="btn-mini bg-red" id="btn-batal-edit" onclick="resetFormAgenda()" style="display:none;">Batal Edit</button>
                </div>
                <input type="hidden" id="agn-id"> 
                <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:10px; margin-bottom:10px;">
                   <div class="form-group"><label class="form-label">Hari</label><select class="form-control" id="agn-hari" onchange="updateAgendaView()"><option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option><option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option></select></div>
                   <div class="form-group"><label class="form-label">Tanggal</label><input type="date" class="form-control" id="agn-tanggal" onchange="updateAgendaView()"></div>
                   <div class="form-group"><label class="form-label">Pilih Jadwal</label><input list="list-jadwal-db" class="form-control" id="agn-jadwal" placeholder="Ketik/Pilih Jadwal..." onchange="parseJadwal(this.value)"><datalist id="list-jadwal-db"></datalist></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                   <div class="form-group"><label class="form-label">Target Kompetensi (TP)</label><input list="list-tp-db" class="form-control" id="agn-tp" placeholder="Ambil dari DB TP..." oninput="updateAgendaView()"><datalist id="list-tp-db"></datalist></div>
                   <div class="form-group"><label class="form-label">Materi Pokok (Aktivitas)</label><input list="list-materi-db" class="form-control" id="agn-materi" placeholder="Ambil dari Modul..." oninput="updateAgendaView()"><datalist id="list-materi-db"></datalist></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                   <div class="form-group"><label class="form-label">Alat / Bahan</label><textarea class="form-control" id="agn-alat" rows="2" oninput="updateAgendaView()">Buku Paket, Spidol</textarea></div>
                   <div class="form-group"><label class="form-label">Tugas Siswa</label><textarea class="form-control" id="agn-tugas" rows="2" oninput="updateAgendaView()">Latihan Halaman...</textarea></div>
                   <div class="form-group"><label class="form-label">Catatan Khusus</label><textarea class="form-control" id="agn-catatan" rows="2" oninput="updateAgendaView()">-</textarea></div>
                </div>
                <div style="text-align:right; margin-top:10px;">
                   <button class="btn-simpan" id="btn-simpan-agn" onclick="simpanAgenda()" style="width:auto;"><i class="fas fa-save"></i> SIMPAN KE DB</button>
                   <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto;"><i class="fas fa-print"></i> CETAK LEMBAR INI</button>
                </div>
             </div>
             <div id="agenda-preview-area" style="background:white; padding:30px; border:1px solid #ccc; box-shadow:0 0 10px rgba(0,0,0,0.1);">
                <div style="text-align:center; border-bottom:2px solid black; padding-bottom:10px; margin-bottom:20px;">
                   <h3 style="margin:0;">AGENDA HARIAN GURU</h3><h4 style="margin:5px 0;">MATA PELAJARAN: <span id="v-mapel-head">MATEMATIKA</span></h4>
                </div>
                <table style="width:100%; font-size:12px; margin-bottom:15px; font-weight:bold;">
                   <tr><td width="15%">Sekolah</td><td>: <span id="v-sekolah">...</span></td></tr>
                   <tr><td>Mata Pelajaran</td><td>: <span id="v-mapel">...</span></td></tr>
                   <tr><td>Kelas / Fase</td><td>: <span id="v-kelas">...</span></td></tr>
                   <tr><td>Tahun Ajaran</td><td>: <span id="v-tahun">...</span></td></tr>
                   <tr><td>Guru Mapel</td><td>: <span id="v-guru">...</span></td></tr>
                </table>
                <table class="doc-table" style="width:100%; margin-bottom:20px;">
                   <tr style="background:#eee;"><th width="20%">Hari / Tanggal</th><th>Target Kompetensi Hari Ini (TP)</th></tr>
                   <tr><td align="center" style="padding:10px;"><span id="v-hari">...</span>, <span id="v-tgl">...</span></td><td style="padding:10px;" id="v-tp">...</td></tr>
                </table>
                <table class="doc-table" style="width:100%;">
                   <tr style="background:#eee;"><th width="15%">Waktu / JP</th><th width="10%">Kelas</th><th width="25%">Materi Pokok (Aktivitas)</th><th width="15%">Alat / Bahan</th><th width="15%">Tugas</th><th width="20%">Catatan Khusus</th></tr>
                   <tr><td align="center" id="v-waktu" style="padding:15px;">...</td><td align="center" id="v-kelas-cell">...</td><td id="v-materi">...</td><td id="v-alat">...</td><td id="v-tugas">...</td><td id="v-catatan">...</td></tr>
                </table>
                <table class="signature-table" border="0" style="margin-top:30px;">
                   <tr>
                      <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="v-kepsek">...</p><p>NIP. <span id="v-nip-kepsek"></span></p></td>
                      <td width="50%"><p><span id="v-kota">...</span>, <span id="v-tgl-ttd">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="v-guru-ttd">...</p><p>NIP. <span id="v-nip"></span></p></td>
                   </tr>
                </table>
             </div>
         </div>
         <div id="agenda-riwayat-view" style="display:none;">
             <div class="form-card btn-print-hide">
                 <h4 style="margin:0 0 10px 0;">Filter Laporan</h4>
                 <div style="display:flex; gap:10px; align-items:end;">
                    <div style="flex:1;"><label class="form-label">Dari Tanggal</label><input type="date" id="lapor-mulai" class="form-control"></div>
                    <div style="flex:1;"><label class="form-label">Sampai Tanggal</label><input type="date" id="lapor-selesai" class="form-control"></div>
                    <button class="btn-simpan bg-blue" onclick="loadLaporanAgenda()" style="width:auto; height:42px;">TAMPILKAN</button>
                    <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto; height:42px;"><i class="fas fa-print"></i> CETAK REKAP</button>
                 </div>
             </div>
             <div id="laporan-container" style="background:white; padding:20px; border-radius:10px; min-height:400px;">
                 <div style="text-align:center; color:#999; margin-top:50px;">Silakan pilih tanggal dan klik TAMPILKAN.</div>
             </div>
         </div>
      </div>

      <div id="page-banksoal" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">üìö Bank Soal (Formatif & Sumatif)</h3>
         <div class="presensi-tabs btn-print-hide">
            <button class="tab-btn active" onclick="gantiTabSoal('input')" id="tab-soal-input">Input Soal</button>
            <button class="tab-btn" onclick="gantiTabSoal('cetak')" id="tab-soal-cetak">Lihat & Cetak Dokumen</button>
         </div>
         <div id="banksoal-input-view">
            <div class="form-card btn-print-hide">
                <input type="hidden" id="soal-id">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                   <div class="form-group"><label class="form-label">BAB / Materi</label><input type="text" class="form-control" id="soal-bab" list="list-bab-db"><datalist id="list-bab-db"></datalist></div>
                   <div class="form-group"><label class="form-label">Jenis Soal</label><select class="form-control" id="soal-jenis"><option value="Formatif">Formatif (A)</option><option value="Sumatif">Sumatif (B)</option></select></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                   <div class="form-group"><label class="form-label">TP / Alur</label><input type="text" class="form-control" id="soal-tp" placeholder="Contoh: Alur 1, 2"></div>
                   <div class="form-group"><label class="form-label">Kategori / Topik</label><input type="text" class="form-control" id="soal-kategori" placeholder="Contoh: Operasi Dasar"></div>
                   <div class="form-group"><label class="form-label">Skor / Kriteria</label><input type="text" class="form-control" id="soal-skor" placeholder="Cth: 5, KKM 85"></div>
                </div>
                <div class="form-group"><label class="form-label">Pertanyaan</label><textarea class="form-control" id="soal-tanya" rows="3"></textarea></div>
                <div class="form-group"><label class="form-label">Kunci Jawaban</label><textarea class="form-control" id="soal-jawab" rows="2"></textarea></div>
                <div style="text-align:right;"><button class="btn-simpan" onclick="simpanSoal()" id="btn-simpan-soal"><i class="fas fa-save"></i> SIMPAN SOAL</button></div>
            </div>
         </div>
         <div id="banksoal-cetak-view" style="display:none;">
             <div class="form-card btn-print-hide">
                 <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:10px; align-items:end;">
                    <div style="flex:1;"><label class="form-label">Pilih BAB:</label><select class="form-control" id="filter-bab"><option value="">-- Pilih BAB --</option></select></div>
                    <div style="flex:1;"><label class="form-label">Ketik Kelas / Fase:</label><input type="text" id="filter-kelas-input" class="form-control" placeholder="Cth: IX / D"></div>
                    <div style="text-align:right;"><button class="btn-simpan bg-blue" onclick="loadBankSoalView()" style="width:auto;">TAMPILKAN</button>
                    <button class="btn-simpan bg-dark" onclick="window.print()" style="width:auto;"><i class="fas fa-print"></i> CETAK</button></div>
                 </div>
             </div>
             <div id="banksoal-preview-area" style="background:white; padding:40px; border:1px solid #ccc; min-height:500px;">
                 <div class="doc-header" style="display:block !important;"><h3>BANK SOAL MATEMATIKA</h3><p>Tahun Ajaran: <span id="soal-tahun">2025/2026</span></p></div>
                 <table style="width:100%; font-size:12px; margin-bottom:20px; font-weight:bold;">
                    <tr><td width="15%">Sekolah</td><td>: <span id="soal-sekolah">...</span></td></tr>
                    <tr><td>Mata Pelajaran</td><td>: <span id="soal-mapel">...</span></td></tr>
                    <tr><td>Kelas / Fase</td><td>: <span id="soal-kelas-view">...</span></td></tr>
                 </table>
                 <div id="konten-bank-soal"><div style="text-align:center; color:#aaa; margin-top:50px;">Silakan pilih BAB, Isi Kelas, dan klik TAMPILKAN.</div></div>
                 <table class="signature-table" border="0" style="margin-top:30px;">
                    <tr>
                       <td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="soal-kepsek">...</p><p>NIP. <span id="soal-nip-kepsek"></span></p></td>
                       <td width="50%"><p><span id="soal-kota">...</span>, <span id="soal-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="soal-guru">...</p><p>NIP. <span id="soal-nip-guru"></span></p></td>
                    </tr>
                 </table>
             </div>
         </div>
      </div>

      <div id="page-pengaturan" class="hidden-page">
         <div onclick="keMenuUtama()" class="btn-back"><i class="fas fa-arrow-left"></i> Kembali</div>
         <h3 class="mb-3">‚öôÔ∏è Pengaturan Aplikasi</h3>
         <div class="form-card">
            <h4 style="margin:0 0 15px 0; color:#007bff;">1. Identitas Sekolah & Mapel</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
               <div class="form-group"><label class="form-label">Nama Sekolah</label><input type="text" class="form-control" id="set-nama_sekolah"></div>
               <div class="form-group"><label class="form-label">Mata Pelajaran</label><input type="text" class="form-control" id="set-mata_pelajaran"></div>
               <div class="form-group"><label class="form-label">Kota / Tempat</label><input type="text" class="form-control" id="set-kota_sekolah"></div>
               <div class="form-group"><label class="form-label">Tahun Pelajaran</label><input type="text" class="form-control" id="set-tahun_pelajaran"></div>
            </div>
            <h4 style="margin:0 0 15px 0; color:#007bff;">2. Identitas Personil</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
               <div class="form-group"><label class="form-label">Nama Guru</label><input type="text" class="form-control" id="set-nama_guru"></div>
               <div class="form-group"><label class="form-label">NIP Guru</label><input type="text" class="form-control" id="set-nip_guru"></div>
               <div class="form-group"><label class="form-label">Nama Kepala Sekolah</label><input type="text" class="form-control" id="set-kepala_sekolah"></div>
               <div class="form-group"><label class="form-label">NIP Kepala Sekolah</label><input type="text" class="form-control" id="set-nip_kepsek"></div>
            </div>
            <h4 style="margin:0 0 15px 0; color:#007bff;">3. Konfigurasi Sistem</h4>
            <div class="form-group"><label class="form-label">ID Folder Foto Siswa (Google Drive)</label><input type="text" class="form-control" id="set-folder_foto_siswa"></div>
            <div class="form-group"><label class="form-label">Link Gambar Kalender</label><input type="text" class="form-control" id="set-kalender_img"></div>
            <div class="form-group"><label class="form-label">Link PDF Kalender (Opsional)</label><input type="text" class="form-control" id="set-kalender_pdf"></div>
            <div class="form-group"><label class="form-label">Deskripsi CP / Prota (Opsional)</label><textarea class="form-control" rows="2" id="set-deskripsi_cp_prota"></textarea></div>
            <div style="text-align:right; margin-top:20px;">
               <button class="btn-simpan bg-green" onclick="simpanPengaturan()" id="btn-save-set" style="width:auto; padding:12px 30px;"><i class="fas fa-save"></i> SIMPAN PERUBAHAN</button>
            </div>
         </div>
      </div>
      <div class="bottom-nav">
       <div class="nav-item active" onclick="bukaTabBawah('beranda')" id="nav-beranda">
          <i class="fas fa-home nav-icon"></i>
          <span class="nav-text">Beranda</span>
       </div>
       <div class="nav-item" onclick="bukaTabBawah('atur')" id="nav-atur">
          <i class="fas fa-cog nav-icon"></i>
          <span class="nav-text">Atur</span>
       </div>
       <div class="nav-item" onclick="bukaTabBawah('profil')" id="nav-profil">
          <i class="fas fa-user nav-icon"></i>
          <span class="nav-text">Profil</span>
       </div>
    </div>

    </div>
    
    <script>
      function bukaTabBawah(tab) {
          // Reset Navigasi
          document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
          // Sembunyikan Semua Tab & Halaman Sub-Menu
          document.querySelectorAll('.main-tab').forEach(el => el.style.display = 'none');
          document.querySelectorAll('.hidden-page').forEach(el => el.style.display = 'none');
          
          if (tab === 'beranda') {
              document.getElementById('tab-beranda').style.display = 'block';
              document.getElementById('nav-beranda').classList.add('active');
          } 
          else if (tab === 'atur') {
              document.getElementById('tab-pengaturan').style.display = 'block';
              document.getElementById('nav-atur').classList.add('active');
              // Trik: Pindahkan Form Pengaturan ke Tab ini
              const formAsli = document.querySelector('#page-pengaturan .form-card');
              const wadahTab = document.getElementById('area-form-pengaturan');
              if(formAsli && wadahTab.innerHTML === "") {
                  wadahTab.appendChild(formAsli); 
                  bukaPengaturan(); // Load data
              }
          } 
          else if (tab === 'profil') {
              document.getElementById('tab-profil').style.display = 'block';
              document.getElementById('nav-profil').classList.add('active');
              // Load Info untuk Profil
              loadInfoSekolah('prof');
          }
      }

      // --- 1. KONFIGURASI GLOBAL ---
      var urlLogin = "https://script.google.com/macros/s/AKfycbwwhLeEYV6GqbJyZGqnRoQiLa3tqDeKR7X_sZy-qZGprbdlOs4t3onc-h6MrBO-D1Lg/exec"; // Ganti dengan URL Web App Final Nanti
      
      function logout() { 
        if(confirm("Keluar dari aplikasi?")) window.top.location.href = urlLogin; 
      }
      function keMenuUtama() { 
        // Tutup semua halaman sub-menu
        document.querySelectorAll('.hidden-page').forEach(el => el.style.display = 'none');
        // Panggil Tab Beranda (Home)
        bukaTabBawah('beranda'); 
      }
      
      function bukaHalaman(id, callback) { 
        // 1. Sembunyikan semua Tab Utama (Beranda/Atur/Profil)
        document.querySelectorAll('.main-tab').forEach(el => el.style.display = 'none');
        
        // 2. Sembunyikan halaman sub-menu lain
        document.querySelectorAll('.hidden-page').forEach(el => el.style.display = 'none');
        
        // 3. Tampilkan halaman target
        document.getElementById(id).style.display = 'block'; 
        
        // 4. Scroll ke atas
        window.scrollTo(0,0);

        if(callback) callback(); 
      }

      function getTanggalIndo() { 
        const t = new Date(); 
        return t.getDate() + " " + ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][t.getMonth()] + " " + t.getFullYear(); 
      }
      
      // --- 2. LOAD INFO SEKOLAH (DINAMIS DARI PENGATURAN - FIXED HEADER GURU) ---
      function loadInfoSekolah(prefix) { 
         google.script.run.withSuccessHandler(i => {
             // Mapping Data Backend ke ID Frontend
             const map = {
                 'sekolah': i.sekolah, 
                 'mapel': i.mapel, 
                 'mapel-head': i.mapel.toUpperCase(),
                 'tahun': i.tahun || "2025/2026", 
                 'kepsek': i.kepsek, 
                 'nip-kepsek': i.nip_kepsek,
                 'guru': i.guru, 
                 'guru-ttd': i.guru, 
                 'guru-head': i.guru, // <--- [FIX] INI KUNCI AGAR NAMA MUNCUL DI HEADER ATP
                 'nip': i.nip, 
                 'nip-guru': i.nip,
                 'kota': i.kota, 
                 'tanggal': getTanggalIndo(), 
                 'tgl': getTanggalIndo()
             };
             
             // Loop untuk mengisi span/div di HTML
             for (const k in map) {
                 const el = document.getElementById(prefix + '-' + k);
                 if (el) el.innerText = map[k] || "...";
             }
         }).getInfoSekolah(); 
      }

      // --- 3. NAVIGASI MENU UTAMA ---
      function bukaMenu(n) {
         if(n==='Kalender') bukaHalaman('page-kalender', loadKalender);
         else if(n==='Jadwal') bukaHalaman('page-jadwal', loadJadwal);
         else if(n==='Murid') bukaHalaman('page-murid', loadMurid);
         else if(n==='Presensi') bukaHalaman('page-presensi', loadPresensi);
         else if(n==='CP') bukaHalaman('page-cp', loadCP);
         else if(n==='TP') bukaHalaman('page-tp', loadTP);
         else if(n==='ATP') bukaHalaman('page-atp');
         else if(n==='Modul') bukaMenuModul(); // <--- INI PENTING
         else if(n==='Prota') bukaHalaman('page-prota');
         else if(n==='Prosem') bukaMenuProsem();
         else if(n==='KKTP') bukaMenuKKTP();
         else if(n==='PAS') bukaHalaman('page-pas');
         else if(n==='Pengaturan') bukaTabBawah('atur'); 
         else alert("Menu "+n+" belum diaktifkan.");
      }

      // --- 4. LOGIKA MODUL TAMBAHAN ---
      
      // --- A. LOGIKA KALENDER (FULL FEATURE) ---
      function loadKalender() {
          document.getElementById('loader-kalender').style.display = 'block';
          document.getElementById('img-kalender').style.display = 'none';
          document.getElementById('tabel-agenda-body').innerHTML = '<tr><td colspan="5" align="center">Memuat data...</td></tr>';
          
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-kalender').style.display = 'none';
              
              // 1. Render Gambar & PDF
              if (data.files.img) {
                  document.getElementById('img-kalender').src = data.files.img;
                  document.getElementById('img-kalender').style.display = 'block';
              } else {
                  document.getElementById('msg-error-kalender').style.display = 'block';
              }
              
              if (data.files.pdf) {
                  document.getElementById('link-download-kalender').href = data.files.pdf;
                  document.getElementById('btn-area-kalender').style.display = 'block';
              }

              // 2. Render Tabel Agenda
              let html = '';
              if (data.agenda.length === 0) {
                  html = '<tr><td colspan="5" align="center">Belum ada agenda. Silakan tambah di atas.</td></tr>';
              } else {
                  data.agenda.forEach((row, idx) => {
                      // Styling: Libur merah, Sekolah hitam
                      let color = (row.label === 'libur') ? 'color:red; font-weight:bold;' : 'color:black;';
                      let badge = (row.label === 'libur') ? 'bg-red' : 'bg-green';
                      
                      // Data JSON untuk tombol edit
                      let rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                      
                      html += `
                      <tr>
                          <td align="center">${idx + 1}</td> <td style="${color}">${row.tanggal}</td>
                          <td>${row.kegiatan}</td>
                          <td align="center"><span class="btn-mini ${badge}" style="font-size:9px;">${row.label.toUpperCase()}</span></td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editAgendaKalender(${rowJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusAgendaKalender('${row.rowIndex}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-agenda-body').innerHTML = html;

          }).getKalenderData();
      }

      // Fungsi Simpan (Tambah/Update)
      function simpanAgendaKalender() {
          const btn = document.getElementById('btn-kal-simpan');
          const tgl = document.getElementById('kal-tanggal').value;
          const keg = document.getElementById('kal-kegiatan').value;
          
          if(!tgl || !keg) { alert("Tanggal dan Kegiatan wajib diisi!"); return; }
          
          btn.disabled = true; btn.innerText = "Menyimpan...";
          
          const data = {
              rowIndex: document.getElementById('kal-rowIndex').value, // Jika ada isi = Edit
              no: "", // Biarkan backend yang urus/auto
              tanggal: tgl,
              kegiatan: keg,
              label: document.getElementById('kal-label').value
          };
          
          google.script.run.withSuccessHandler(res => {
              alert(res);
              resetFormKalender();
              loadKalender(); // Reload tabel
          }).simpanAgendaKalender(data);
      }

      // Fungsi Edit (Isi Form)
      function editAgendaKalender(data) {
          document.getElementById('kal-rowIndex').value = data.rowIndex;
          document.getElementById('kal-tanggal').value = data.tanggal;
          document.getElementById('kal-kegiatan').value = data.kegiatan;
          document.getElementById('kal-label').value = data.label;
          
          // Ubah tombol
          document.getElementById('btn-kal-simpan').innerHTML = '<i class="fas fa-save"></i> UPDATE';
          document.getElementById('btn-kal-simpan').classList.remove('bg-green');
          document.getElementById('btn-kal-simpan').classList.add('bg-orange');
          document.getElementById('btn-kal-batal').style.display = 'inline-block';
      }

      // Fungsi Hapus
      function hapusAgendaKalender(rowIndex) {
          if(confirm("Yakin ingin menghapus agenda ini?")) {
              google.script.run.withSuccessHandler(res => {
                  loadKalender();
              }).hapusAgendaKalender(rowIndex);
          }
      }

      // Fungsi Reset Form
      function resetFormKalender() {
          document.getElementById('kal-rowIndex').value = "";
          document.getElementById('kal-tanggal').value = "";
          document.getElementById('kal-kegiatan').value = "";
          document.getElementById('kal-label').value = "sekolah";
          
          document.getElementById('btn-kal-simpan').innerHTML = '<i class="fas fa-plus"></i> TAMBAH';
          document.getElementById('btn-kal-simpan').classList.add('bg-green');
          document.getElementById('btn-kal-simpan').classList.remove('bg-orange');
          document.getElementById('btn-kal-simpan').disabled = false;
          document.getElementById('btn-kal-batal').style.display = 'none';
      }

      // --- B. LOGIKA JADWAL (CRUD FULL) ---
      function loadJadwal() {
          document.getElementById('loader-jadwal').style.display = 'block';
          document.getElementById('tabel-jadwal-body').innerHTML = '';
          
          // Load Info Sekolah untuk Header Cetak
          loadInfoSekolah('jad'); 
          
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-jadwal').style.display = 'none';
              let html = '';
              
              if (!data || data.length === 0) {
                  html = '<tr><td colspan="7" align="center">Belum ada jadwal. Tambahkan di atas.</td></tr>';
              } else {
                  // Urutkan: Senin(1)..Sabtu(6), lalu Jam Ke
                  const hariOrder = { "Senin": 1, "Selasa": 2, "Rabu": 3, "Kamis": 4, "Jumat": 5, "Sabtu": 6 };
                  data.sort((a, b) => {
                      if (hariOrder[a.hari] !== hariOrder[b.hari]) {
                          return hariOrder[a.hari] - hariOrder[b.hari];
                      }
                      return a.jam - b.jam;
                  });

                  data.forEach((row, idx) => {
                      const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                      html += `
                      <tr>
                          <td align="center">${idx + 1}</td>
                          <td style="font-weight:bold;">${row.hari}</td>
                          <td align="center">${row.jam}</td>
                          <td align="center">${row.waktu}</td>
                          <td align="center" style="background:#e3f2fd;">${row.kelas}</td>
                          <td>${row.mapel}</td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editJadwal(${rowJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusJadwal('${row.rowIndex}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-jadwal-body').innerHTML = html;
          }).getJadwalData();
      }

      function simpanJadwal() {
          const btn = document.getElementById('btn-jad-simpan');
          const data = {
              rowIndex: document.getElementById('jad-rowIndex').value, // ID Edit
              hari: document.getElementById('jad-hari').value,
              jam: document.getElementById('jad-jam').value,
              waktu: document.getElementById('jad-waktu').value,
              kelas: document.getElementById('jad-kelas').value,
              mapel: document.getElementById('jad-mapel').value
          };
          
          if (!data.jam || !data.waktu || !data.kelas || !data.mapel) {
              alert("Lengkapi semua kolom!"); return;
          }
          
          btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          google.script.run.withSuccessHandler(res => {
              alert(res);
              resetFormJadwal();
              loadJadwal(); // Reload tabel
          }).simpanJadwal(data);
      }

      function editJadwal(d) {
          document.getElementById('jad-rowIndex').value = d.rowIndex;
          document.getElementById('jad-hari').value = d.hari;
          document.getElementById('jad-jam').value = d.jam;
          document.getElementById('jad-waktu').value = d.waktu;
          document.getElementById('jad-kelas').value = d.kelas;
          document.getElementById('jad-mapel').value = d.mapel;
          
          // Ubah tombol jadi Update
          document.getElementById('btn-jad-simpan').innerHTML = '<i class="fas fa-save"></i>';
          document.getElementById('btn-jad-simpan').classList.remove('bg-green');
          document.getElementById('btn-jad-simpan').classList.add('bg-orange');
          document.getElementById('btn-jad-batal').style.display = 'block';
      }

      function hapusJadwal(id) {
          if(confirm("Hapus jadwal ini?")) {
              google.script.run.withSuccessHandler(res => {
                  loadJadwal();
              }).hapusJadwal(id);
          }
      }

      function resetFormJadwal() {
          document.getElementById('jad-rowIndex').value = "";
          document.getElementById('jad-jam').value = "";
          document.getElementById('jad-waktu').value = "";
          document.getElementById('jad-kelas').value = "";
          document.getElementById('jad-mapel').value = "";
          
          document.getElementById('btn-jad-simpan').innerHTML = '<i class="fas fa-plus"></i>';
          document.getElementById('btn-jad-simpan').classList.add('bg-green');
          document.getElementById('btn-jad-simpan').classList.remove('bg-orange');
          document.getElementById('btn-jad-simpan').disabled = false;
          document.getElementById('btn-jad-batal').style.display = 'none';
      }
      // --- C. LOGIKA MURID (GROUPING KELAS + SORTING A-Z) ---
      
      // 1. Load Data & Grouping
      function loadMurid() {
          document.getElementById('loader-murid').style.display = 'block';
          const container = document.getElementById('daftar-siswa-container');
          container.innerHTML = ''; // Bersihkan wadah sebelum isi ulang
          
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-murid').style.display = 'none';
              
              if (!data || data.length === 0) {
                  container.innerHTML = '<div class="text-center" style="padding:20px; color:#666;">Belum ada data siswa.</div>';
                  return;
              }

              // A. GROUPING DATA BERDASARKAN KELAS
              const groups = {};
              data.forEach(siswa => {
                  // Jika kelas kosong, masukkan ke grup "LAINNYA"
                  let kls = siswa.kelas ? siswa.kelas.toUpperCase() : "BELUM ADA KELAS";
                  if (!groups[kls]) groups[kls] = [];
                  groups[kls].push(siswa);
              });

              // B. URUTKAN DAFTAR KELAS (7A, 7B, 8A...)
              const sortedClasses = Object.keys(groups).sort();

              // C. LOOP SETIAP KELAS -> BUAT TABEL
              let fullHtml = '';
              
              sortedClasses.forEach(kelas => {
                  // 1. Urutkan Siswa A-Z di dalam kelas ini
                  const sortedStudents = groups[kelas].sort((a, b) => a.nama.localeCompare(b.nama));

                  // 2. Buat Judul Kelas
                  fullHtml += `<h5 style="background:#007bff; color:white; padding:8px 15px; border-radius:5px; margin-top:25px; margin-bottom:5px; font-weight:bold;">
                                <i class="fas fa-users"></i> KELAS ${kelas} <span style="font-size:11px; opacity:0.8; margin-left:5px;">(${sortedStudents.length} Siswa)</span>
                               </h5>`;
                  
                  // 3. Buat Header Tabel
                  fullHtml += `
                  <div style="overflow-x:auto; margin-bottom:15px; border:1px solid #ddd; border-radius:5px; background:white;">
                    <table class="doc-table tabel-siswa-item" style="width:100%; margin:0;">
                      <thead style="background:#f8f9fa;">
                         <tr>
                            <th width="5%">No</th>
                            <th width="8%">Foto</th>
                            <th>Nama Lengkap</th>
                            <th width="12%">NIS</th>
                            <th width="5%">L/P</th>
                            <th width="10%">Status</th>
                            <th width="12%" class="btn-print-hide">Aksi</th>
                         </tr>
                      </thead>
                      <tbody>`;
                  
                  // 4. Isi Baris Siswa
                  sortedStudents.forEach((row, idx) => {
                      let linkFoto = (row.fotoId && row.fotoId.length > 5) 
                          ? "https://drive.google.com/thumbnail?id=" + row.fotoId + "&sz=w100" 
                          : "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
                      
                      const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                      
                      // Kita tambah class 'baris-siswa' dan 'nama-siswa' untuk fitur pencarian
                      fullHtml += `
                      <tr class="baris-siswa">
                          <td align="center">${idx + 1}</td>
                          <td align="center"><img src="${linkFoto}" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #ccc;"></td>
                          <td style="font-weight:500;" class="nama-siswa">${row.nama}</td>
                          <td align="center">${row.nis}</td>
                          <td align="center">${row.jk}</td>
                          <td align="center"><span class="btn-mini ${row.status=='Aktif'?'bg-green':'bg-red'}" style="font-size:9px;">${row.status}</span></td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editMurid(${rowJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusMurid('${row.rowIdx}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });

                  fullHtml += `</tbody></table></div>`;
              });

              container.innerHTML = fullHtml;

          }).getMuridData();
      }

      // 2. Helper Preview Foto
      let fileFotoBase64 = null;
      let fileNameFoto = null;

      function previewImage(input) {
          if (input.files && input.files[0]) {
              const file = input.files[0];
              if(file.size > 2 * 1024 * 1024) { alert("Ukuran foto terlalu besar! Maks 2MB."); input.value=""; return; }
              const reader = new FileReader();
              reader.onload = function(e) {
                  document.getElementById('preview-foto').src = e.target.result;
                  fileFotoBase64 = e.target.result; 
                  fileNameFoto = file.name;
              }
              reader.readAsDataURL(file);
          }
      }

      // 3. Proses Simpan (Baru / Edit)
      function prosesSimpanMurid() {
          const btn = document.getElementById('btn-mur-simpan');
          const nama = document.getElementById('mur-nama').value;
          if (!nama) { alert("Nama wajib diisi!"); return; }
          
          btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
          
          const formData = {
              rowIdx: document.getElementById('mur-rowIdx').value, 
              oldFotoId: document.getElementById('mur-oldFotoId').value,
              nama: nama,
              nis: document.getElementById('mur-nis').value,
              jk: document.getElementById('mur-jk').value,
              kelas: document.getElementById('mur-kelas').value,
              status: document.getElementById('mur-status').value,
              fotoData: fileFotoBase64, 
              fotoNama: fileNameFoto
          };
          
          if (formData.rowIdx) {
              google.script.run.withSuccessHandler(res => { alert(res); finishSimpanMurid(); }).updateMurid(formData);
          } else {
              google.script.run.withSuccessHandler(res => { alert(res); finishSimpanMurid(); }).simpanMuridBaru(formData);
          }
      }

      function finishSimpanMurid() {
          resetFormMurid();
          loadMurid();
          document.getElementById('btn-mur-simpan').disabled = false;
          document.getElementById('btn-mur-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN DATA';
      }

      // 4. Edit
      function editMurid(d) {
          document.getElementById('mur-rowIdx').value = d.rowIdx;
          document.getElementById('mur-oldFotoId').value = d.fotoId;
          document.getElementById('mur-nama').value = d.nama;
          document.getElementById('mur-nis').value = d.nis;
          document.getElementById('mur-jk').value = d.jk;
          document.getElementById('mur-kelas').value = d.kelas;
          document.getElementById('mur-status').value = d.status;
          
          if(d.fotoId && d.fotoId.length > 5) {
              document.getElementById('preview-foto').src = "https://drive.google.com/thumbnail?id=" + d.fotoId + "&sz=w200";
          } else {
              document.getElementById('preview-foto').src = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
          }
          
          document.getElementById('btn-mur-simpan').innerHTML = '<i class="fas fa-sync"></i> UPDATE DATA';
          document.getElementById('btn-mur-batal').style.display = 'inline-block';
          document.getElementById('page-murid').scrollIntoView({behavior: "smooth"});
      }

      // 5. Hapus
      function hapusMurid(id) {
          if(confirm("Hapus data siswa ini? Foto di Drive tidak akan terhapus.")) {
              google.script.run.withSuccessHandler(res => { loadMurid(); }).hapusMurid(id);
          }
      }

      // 6. Reset
      function resetFormMurid() {
          document.getElementById('mur-rowIdx').value = "";
          document.getElementById('mur-oldFotoId').value = "";
          document.getElementById('mur-nama').value = "";
          document.getElementById('mur-nis').value = "";
          document.getElementById('mur-kelas').value = "";
          document.getElementById('mur-foto').value = ""; 
          fileFotoBase64 = null; fileNameFoto = null;
          
          document.getElementById('preview-foto').src = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
          document.getElementById('btn-mur-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN DATA';
          document.getElementById('btn-mur-batal').style.display = 'none';
      }
      
      // 7. Filter Pencarian Tabel (Updated untuk Multi Table)
      function filterTabelSiswa() {
          let input = document.getElementById("cari-siswa");
          let filter = input.value.toUpperCase();
          // Cari semua baris yang punya class 'baris-siswa'
          let rows = document.getElementsByClassName("baris-siswa");
          
          for (let i = 0; i < rows.length; i++) {
              let td = rows[i].getElementsByClassName("nama-siswa")[0];
              if (td) {
                  let txtValue = td.textContent || td.innerText;
                  if (txtValue.toUpperCase().indexOf(filter) > -1) {
                      rows[i].style.display = "";
                  } else {
                      rows[i].style.display = "none";
                  }
              }       
          }
      }
      // --- D. LOGIKA PRESENSI (CRUD + REKAP) ---
      
      // 0. Navigasi Tab
      function gantiTabPresensi(tab) {
          if(tab == 'input') {
              document.getElementById('view-presensi-input').style.display='block';
              document.getElementById('view-presensi-rekap').style.display='none';
              document.getElementById('tab-pres-input').classList.add('active');
              document.getElementById('tab-pres-rekap').classList.remove('active');
          } else {
              document.getElementById('view-presensi-input').style.display='none';
              document.getElementById('view-presensi-rekap').style.display='block';
              document.getElementById('tab-pres-input').classList.remove('active');
              document.getElementById('tab-pres-rekap').classList.add('active');
          }
      }

      // 1. Load Awal (Dropdown Kelas)
      function loadPresensi() {
          const elTgl = document.getElementById('pres-tgl');
          if(elTgl) elTgl.valueAsDate = new Date(); 
          
          google.script.run.withSuccessHandler(listKelas => {
              let html = '<option value="">-- Pilih Kelas --</option>';
              listKelas.forEach(k => html += `<option value="${k}">${k}</option>`);
              // Isi ke dua dropdown (Input & Rekap)
              document.getElementById('pres-kelas').innerHTML = html;
              document.getElementById('rekap-kelas').innerHTML = html;
          }).getListKelas();
          
          // Load Info Sekolah untuk Tanda Tangan
          loadInfoSekolah('pres'); 
      }

      // 2. Cek Apakah Edit Mode (Hanya Ubah UI)
      function cekEditMode() {
          // Fungsi ini opsional, data real dimuat saat klik tombol "MUAT DATA SISWA"
          document.getElementById('tabel-presensi-body').innerHTML = '<tr><td colspan="4" align="center" style="padding:20px; color:#999;">Klik tombol <b>MUAT DATA SISWA</b> untuk memulai.</td></tr>';
          document.getElementById('btn-pres-simpan').classList.remove('bg-orange');
          document.getElementById('btn-pres-simpan').classList.add('bg-green');
          document.getElementById('btn-pres-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN KE DB';
      }

      // 3. Load Siswa (Cek Data Lama juga)
      function loadSiswaPresensi() {
          const kelas = document.getElementById('pres-kelas').value;
          const tgl = document.getElementById('pres-tgl').value;
          const mapel = document.getElementById('pres-mapel').value;
          
          if(!kelas || !tgl || !mapel) { alert("Lengkapi Tanggal, Kelas, dan Mapel!"); return; }
          
          document.getElementById('loader-presensi').style.display = 'block';
          document.getElementById('tabel-presensi-body').innerHTML = '';
          
          google.script.run.withSuccessHandler(res => {
              document.getElementById('loader-presensi').style.display = 'none';
              
              // Ganti Judul & Tombol jika Edit Mode
              if (res.editMode) {
                  document.getElementById('judul-tabel-presensi').innerHTML = 'Edit Kehadiran (Data Tersimpan Ditemukan)';
                  document.getElementById('judul-tabel-presensi').style.color = '#ff9800'; // Orange
                  const btn = document.getElementById('btn-pres-simpan');
                  btn.innerHTML = '<i class="fas fa-sync"></i> UPDATE DATA';
                  btn.classList.remove('bg-green');
                  btn.classList.add('bg-orange');
              } else {
                  document.getElementById('judul-tabel-presensi').innerHTML = 'Input Kehadiran Baru';
                  document.getElementById('judul-tabel-presensi').style.color = '#007bff'; // Blue
              }
              
              let siswaList = res.siswa;
              let html = '';
              
              if(siswaList.length === 0) {
                  html = '<tr><td colspan="4" align="center">Tidak ada siswa.</td></tr>';
              } else {
                  siswaList.sort((a, b) => a.nama.localeCompare(b.nama));
                  siswaList.forEach((s, i) => {
                      const idx = i + 1;
                      // Tentukan Radio Mana yang Checked
                      const isH = s.status == 'Hadir' ? 'checked' : '';
                      const isS = s.status == 'Sakit' ? 'checked' : '';
                      const isI = s.status == 'Izin' ? 'checked' : '';
                      const isA = s.status == 'Alpha' ? 'checked' : '';
                      
                      html += `
                      <tr class="baris-absen">
                          <td align="center">${idx}</td>
                          <td style="font-weight:500;">
                              <input type="hidden" class="absen-nama" value="${s.nama}">
                              ${s.nama}<br><small style="color:#888;">${s.nis}</small>
                          </td>
                          <td align="center">
                              <div style="display:flex; justify-content:center; gap:10px;">
                                  <label><input type="radio" name="st_${idx}" value="Hadir" ${isH}> <b>H</b></label>
                                  <label><input type="radio" name="st_${idx}" value="Sakit" ${isS}> S</label>
                                  <label><input type="radio" name="st_${idx}" value="Izin" ${isI}> I</label>
                                  <label><input type="radio" name="st_${idx}" value="Alpha" ${isA}> A</label>
                              </div>
                          </td>
                          <td>
                              <input type="text" class="absen-ket inp-nilai" value="${s.ket}" placeholder="-">
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-presensi-body').innerHTML = html;
          }).getSiswaPresensiView(kelas, tgl, mapel);
      }

      // 4. Simpan Data
      function simpanPresensi() {
          const btn = document.getElementById('btn-pres-simpan');
          const tgl = document.getElementById('pres-tgl').value;
          const kelas = document.getElementById('pres-kelas').value;
          const mapel = document.getElementById('pres-mapel').value;
          
          const rows = document.getElementsByClassName('baris-absen');
          if (rows.length === 0) { alert("Tidak ada data untuk disimpan."); return; }
          
          btn.disabled = true; btn.innerText = 'Memproses...';
          
          let listSiswaAbsen = [];
          for(let i=0; i<rows.length; i++) {
              const nama = rows[i].querySelector('.absen-nama').value;
              const ket = rows[i].querySelector('.absen-ket').value;
              let status = "Hadir";
              rows[i].querySelectorAll('input[type="radio"]').forEach(r => { if(r.checked) status = r.value; });
              listSiswaAbsen.push({ nama: nama, status: status, ket: ket });
          }
          
          const dataPayload = { tanggal: tgl, kelas: kelas, mapel: mapel, listSiswa: listSiswaAbsen };
          
          google.script.run.withSuccessHandler(res => {
              alert(res);
              btn.disabled = false;
              // Reset ke mode awal
              cekEditMode(); 
          }).simpanPresensiMassal(dataPayload);
      }

      // 5. Load Rekap
      function loadRekapPresensi() {
          const kelas = document.getElementById('rekap-kelas').value;
          const m = document.getElementById('rekap-mulai').value;
          const a = document.getElementById('rekap-akhir').value;
          
          if(!kelas || !m || !a) { alert("Lengkapi filter!"); return; }
          
          document.getElementById('loader-rekap').style.display = 'block';
          document.getElementById('tabel-rekap-body').innerHTML = '';
          
          // Set Header Cetak
          document.getElementById('cetak-rekap-kelas').innerText = kelas;
          document.getElementById('cetak-rekap-periode').innerText = m + ' s.d. ' + a;
          
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-rekap').style.display = 'none';
              let html = '';
              
              if(data.length === 0) {
                   html = '<tr><td colspan="7" align="center">Data Kosong.</td></tr>';
              } else {
                   data.sort((x,y) => x.nama.localeCompare(y.nama));
                   data.forEach((s, i) => {
                       // Hitung Persentase Kehadiran
                       // Rumus: (H / Total Pertemuan) * 100? Atau sekadar jumlah?
                       // Kita tampilkan jumlah saja biar aman.
                       let total = s.h + s.s + s.i + s.a;
                       let persen = total > 0 ? Math.round((s.h / total) * 100) + "%" : "-";
                       
                       html += `
                       <tr>
                           <td align="center">${i+1}</td>
                           <td style="font-weight:500;">${s.nama}</td>
                           <td align="center" style="background:#e8f5e9;">${s.h}</td>
                           <td align="center">${s.s}</td>
                           <td align="center">${s.i}</td>
                           <td align="center" style="background:#ffebee;">${s.a}</td>
                           <td align="center"><b>${persen}</b></td>
                       </tr>`;
                   });
              }
              document.getElementById('tabel-rekap-body').innerHTML = html;
          }).getRekapPresensi(kelas, m, a);
      }
      // --- E. LOGIKA CP (DENGAN INFO SEKOLAH UNTUK CETAK) ---
      
      function loadCP() {
          document.getElementById('loader-cp').style.display = 'block';
          document.getElementById('tabel-cp-body').innerHTML = '';
          
          // [BARU] Load Info Sekolah untuk Header & Tanda Tangan Cetak
          // Prefix 'cp' akan mengisi id: cp-sekolah, cp-kepsek, cp-guru, dll.
          loadInfoSekolah('cp'); 
          
          // Panggil backend getDataCP
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-cp').style.display = 'none';
              let html = '';
              if (data.length === 0) {
                  html = '<tr><td colspan="5" align="center">Belum ada data CP.</td></tr>';
              } else {
                  data.forEach((row, i) => {
                      const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                      html += `
                      <tr>
                          <td align="center">${i + 1}</td>
                          <td style="font-weight:bold;">${row.elemen}</td>
                          <td align="center"><span class="btn-mini bg-blue">${row.fase}</span></td>
                          <td style="text-align:justify; font-size:12px; line-height:1.5;">${row.isi}</td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editCP(${rowJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusCP('${row.rowIdx}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-cp-body').innerHTML = html;
          }).getDataCP();
      }

      function simpanCP() {
          const btn = document.getElementById('btn-cp-simpan');
          const elemen = document.getElementById('cp-elemen').value;
          const fase = document.getElementById('cp-fase').value;
          const isi = document.getElementById('cp-isi').value;
          
          if (!elemen || !isi) { alert("Lengkapi data CP!"); return; }
          
          btn.disabled = true; btn.innerText = 'Menyimpan...';
          
          const data = {
              rowIdx: document.getElementById('cp-rowIdx').value,
              elemen: elemen,
              fase: fase,
              isi: isi,
              tingkat: "-" // Default
          };
          
          if (data.rowIdx) {
              google.script.run.withSuccessHandler(r => { alert(r); resetFormCP(); loadCP(); }).updateCP(data);
          } else {
              google.script.run.withSuccessHandler(r => { alert(r); resetFormCP(); loadCP(); }).simpanCP(data);
          }
      }

      function editCP(d) {
          document.getElementById('cp-rowIdx').value = d.rowIdx;
          document.getElementById('cp-elemen').value = d.elemen;
          document.getElementById('cp-fase').value = d.fase;
          document.getElementById('cp-isi').value = d.isi; // Backend kirim key 'isi'
          
          document.getElementById('btn-cp-simpan').innerHTML = '<i class="fas fa-sync"></i> UPDATE CP';
          document.getElementById('btn-cp-simpan').classList.remove('bg-purple');
          document.getElementById('btn-cp-simpan').classList.add('bg-orange');
          document.getElementById('btn-cp-batal').style.display = 'inline-block';
          document.getElementById('page-cp').scrollIntoView({behavior: "smooth"});
      }

      function hapusCP(idx) {
          if(confirm("Hapus CP ini?")) {
              google.script.run.withSuccessHandler(r => { loadCP(); }).hapusCP(idx);
          }
      }

      function resetFormCP() {
          document.getElementById('cp-rowIdx').value = "";
          document.getElementById('cp-elemen').value = "";
          document.getElementById('cp-isi').value = "";
          
          document.getElementById('btn-cp-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN CP';
          document.getElementById('btn-cp-simpan').classList.add('bg-purple');
          document.getElementById('btn-cp-simpan').classList.remove('bg-orange');
          document.getElementById('btn-cp-simpan').disabled = false;
          document.getElementById('btn-cp-batal').style.display = 'none';
      }
      // --- F. LOGIKA TP (TUJUAN PEMBELAJARAN) ---
      
      function loadTP() {
          document.getElementById('loader-tp').style.display = 'block';
          document.getElementById('tabel-tp-body').innerHTML = '';
          
          // Load Info Sekolah untuk Cetak
          loadInfoSekolah('tp');
          
          // Ambil Filter Kelas
          const filterKelas = document.getElementById('filter-tp-kelas').value;
          document.getElementById('tp-kelas-head').innerText = filterKelas || "SEMUA KELAS";
          
          // Panggil Backend getDataTP(filterKelas)
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-tp').style.display = 'none';
              let html = '';
              if (data.length === 0) {
                  html = '<tr><td colspan="6" align="center">Belum ada data TP. Silakan input baru.</td></tr>';
              } else {
                  data.forEach((row, i) => {
                      const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                      html += `
                      <tr>
                          <td align="center" style="font-weight:bold;">${row.alur}</td>
                          <td align="center"><span class="btn-mini bg-orange">${row.alokasi}</span></td>
                          <td><b>${row.materi}</b><br><small style="color:#666;">${row.kelas}</small></td>
                          <td style="text-align:justify; font-size:11px;">
                             <b>TP:</b> ${row.tujuan}<br>
                             <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:3px; color:#555;">
                                <i>Pemahaman: ${row.pemahaman}</i>
                             </div>
                          </td>
                          <td style="font-size:10px;">${row.asesmen}<br><br><b>Metode:</b><br>${row.metode}</td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editTP(${rowJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusTP('${row.rowIdx}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-tp-body').innerHTML = html;
          }).getDataTP(filterKelas);
      }

      function simpanTP() {
          const btn = document.getElementById('btn-tp-simpan');
          const alur = document.getElementById('tp-alur').value;
          const materi = document.getElementById('tp-materi').value;
          const tujuan = document.getElementById('tp-tujuan').value;
          
          if (!alur || !materi || !tujuan) { alert("Nomor Alur, Materi, dan Tujuan wajib diisi!"); return; }
          
          btn.disabled = true; btn.innerText = 'Menyimpan...';
          
          const data = {
              rowIdx: document.getElementById('tp-rowIdx').value,
              kelas: document.getElementById('tp-kelas').value,
              alur: alur,
              alokasi: document.getElementById('tp-alokasi').value,
              materi: materi,
              tujuan: tujuan,
              pemahaman: document.getElementById('tp-pemahaman').value,
              asesmen: document.getElementById('tp-asesmen').value,
              metode: document.getElementById('tp-metode').value
          };
          
          const handler = r => { alert(r); resetFormTP(); loadTP(); };
          
          if (data.rowIdx) {
              google.script.run.withSuccessHandler(handler).updateTP(data);
          } else {
              google.script.run.withSuccessHandler(handler).simpanTP(data);
          }
      }

      function editTP(d) {
          document.getElementById('tp-rowIdx').value = d.rowIdx;
          document.getElementById('tp-kelas').value = d.kelas;
          document.getElementById('tp-alur').value = d.alur;
          document.getElementById('tp-alokasi').value = d.alokasi;
          document.getElementById('tp-materi').value = d.materi;
          document.getElementById('tp-tujuan').value = d.tujuan;
          document.getElementById('tp-pemahaman').value = d.pemahaman;
          document.getElementById('tp-asesmen').value = d.asesmen;
          document.getElementById('tp-metode').value = d.metode;
          
          document.getElementById('btn-tp-simpan').innerHTML = '<i class="fas fa-sync"></i> UPDATE TP';
          document.getElementById('btn-tp-simpan').classList.remove('bg-purple');
          document.getElementById('btn-tp-simpan').classList.add('bg-orange');
          document.getElementById('btn-tp-batal').style.display = 'inline-block';
          document.getElementById('page-tp').scrollIntoView({behavior: "smooth"});
      }

      function hapusTP(idx) {
          if(confirm("Hapus TP ini?")) {
              google.script.run.withSuccessHandler(r => { loadTP(); }).hapusTP(idx);
          }
      }

      function resetFormTP() {
          document.getElementById('tp-rowIdx').value = "";
          document.getElementById('tp-alur').value = "";
          document.getElementById('tp-materi').value = "";
          document.getElementById('tp-tujuan').value = "";
          document.getElementById('tp-pemahaman').value = "";
          document.getElementById('tp-asesmen').value = "";
          document.getElementById('tp-metode').value = "";
          document.getElementById('tp-alokasi').value = "";
          
          document.getElementById('btn-tp-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN TP';
          document.getElementById('btn-tp-simpan').classList.add('bg-purple');
          document.getElementById('btn-tp-simpan').classList.remove('bg-orange');
          document.getElementById('btn-tp-simpan').disabled = false;
          document.getElementById('btn-tp-batal').style.display = 'none';
      }
      // --- G. LOGIKA ATP (DENGAN TIMEOUT PROTECTOR) ---
      function generateATP() {
          const fase = document.getElementById('atp-fase').value;
          const kelas = document.getElementById('atp-kelas').value;
          
          // Tampilkan UI
          document.getElementById('atp-preview-area').style.display = 'block';
          document.getElementById('loader-atp').style.display = 'block';
          document.getElementById('konten-atp').style.display = 'none';
          
          // Set Identitas Header
          loadInfoSekolah('atp');
          document.getElementById('atp-fase-view').innerText = fase;
          document.getElementById('atp-kelas-view').innerText = kelas;
          
          // Timer Timeout (Jaga-jaga kalau server macet)
          const timeout = setTimeout(() => {
             document.getElementById('loader-atp').style.display = 'none';
             alert("Koneksi lambat atau Server sibuk. Silakan coba lagi atau Refresh halaman.");
          }, 15000); // 15 detik

          // Panggil Backend
          google.script.run
            .withSuccessHandler(data => {
                clearTimeout(timeout); // Matikan timer karena sukses
                document.getElementById('loader-atp').style.display = 'none';
                
                if (data.success === false) {
                    alert("Gagal: " + data.message);
                    return;
                }

                document.getElementById('konten-atp').style.display = 'block';
                
                // 1. Render CP
                let htmlCP = '';
                if (!data.cp || data.cp.length === 0) {
                    htmlCP = '<p style="color:red; font-style:italic; padding:10px;">Data CP tidak ditemukan untuk Fase ini. Cek Menu Input CP.</p>';
                } else {
                    htmlCP += '<ul style="padding-left:20px; margin-top:5px;">';
                    data.cp.forEach(c => {
                        htmlCP += `<li style="margin-bottom:10px;"><b>${c.elemen}:</b> ${c.isi}</li>`;
                    });
                    htmlCP += '</ul>';
                }
                document.getElementById('list-cp-atp').innerHTML = htmlCP;
                
                // 2. Render TP
                let htmlTP = '';
                if (!data.tp || data.tp.length === 0) {
                    htmlTP = '<tr><td colspan="4" align="center" style="padding:20px; color:red;">Data TP tidak ditemukan untuk Kelas ini. Cek Menu Input TP.</td></tr>';
                } else {
                    data.tp.forEach(t => {
                        htmlTP += `
                        <tr>
                            <td align="center" style="vertical-align:middle;">${t.alur}</td>
                            <td style="font-weight:bold;">${t.materi}</td>
                            <td style="text-align:justify;">${t.tujuan}</td>
                            <td align="center" style="vertical-align:middle;">${t.alokasi}</td>
                        </tr>`;
                    });
                }
                document.getElementById('tabel-atp-body').innerHTML = htmlTP;
            })
            .withFailureHandler(err => {
                clearTimeout(timeout);
                document.getElementById('loader-atp').style.display = 'none';
                alert("Gagal memuat data (Server Error): " + err);
            })
            .getDataATP(kelas, fase);
      }
      // --- H. LOGIKA MODUL AJAR (ADVANCED JSON HANDLING) ---
      
      let pertemuanCount = 0;

      function bukaMenuModul() {
          bukaHalaman('page-modul');
          gantiTabModul('data');
          loadModul();
      }

      function gantiTabModul(tab) {
          if(tab == 'data') {
              document.getElementById('view-modul-data').style.display = 'block';
              document.getElementById('view-modul-input').style.display = 'none';
              document.getElementById('view-modul-cetak').style.display = 'none';
              document.getElementById('tab-mod-data').classList.add('active');
              document.getElementById('tab-mod-input').classList.remove('active');
          } else {
              document.getElementById('view-modul-data').style.display = 'none';
              document.getElementById('view-modul-input').style.display = 'block';
              document.getElementById('view-modul-cetak').style.display = 'none';
              document.getElementById('tab-mod-data').classList.remove('active');
              document.getElementById('tab-mod-input').classList.add('active');
              if(pertemuanCount === 0) tambahPertemuan(); // Auto add 1 pertemuan jika kosong
          }
      }

      // 1. Load Data Tabel
      function loadModul() {
          document.getElementById('loader-modul').style.display = 'block';
          document.getElementById('tabel-modul-body').innerHTML = '';
          const fk = document.getElementById('filter-modul-kelas').value;
          
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-modul').style.display = 'none';
              let html = '';
              if (data.length === 0) {
                  html = '<tr><td colspan="5" align="center">Belum ada Modul Ajar. Buat baru yuk!</td></tr>';
              } else {
                  data.forEach((row, i) => {
                      // Serialize objek agar aman dikirim ke fungsi Edit/Cetak
                      const rowStr = JSON.stringify(row).replace(/"/g, '&quot;');
                      html += `
                      <tr>
                          <td align="center">${i + 1}</td>
                          <td><b>Fase ${row.fase}</b><br>Kelas ${row.kelas}</td>
                          <td style="font-weight:500;">${row.materi}</td>
                          <td align="center">${row.alokasi}</td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini bg-blue" onclick="cetakModulView(${rowStr})" title="Cetak"><i class="fas fa-print"></i></button>
                              <button class="btn-mini btn-edit" onclick="editModul(${rowStr})" title="Edit"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusModul('${row.rowIdx}')" title="Hapus"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-modul-body').innerHTML = html;
          }).getDataModul(fk);
      }

      // 2. Load Opsi TP (Fitur Pintar)
      function loadOpsiTPModul() {
          const kls = document.getElementById('mod-kelas').value;
          if(!kls) return;
          google.script.run.withSuccessHandler(tps => {
              let h = '';
              tps.forEach(t => h += `<option value="${t}">`);
              document.getElementById('list-tp-modul').innerHTML = h;
          }).getOpsiTP(kls);
      }

      // 3. Dynamic Pertemuan (Kegiatan)
      function tambahPertemuan(data = null) {
          pertemuanCount++;
          const id = pertemuanCount;
          const isi = data ? data.rincian : "";
          const html = `
          <div id="pertemuan-${id}" class="form-group" style="border:1px dashed #ccc; padding:10px; border-radius:5px; margin-bottom:10px; background:#fafafa;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                  <label class="form-label" style="color:#007bff;">Kegiatan Pembelajaran (Pertemuan ke-${id})</label>
                  <button class="btn-mini bg-red" onclick="hapusPertemuan(${id})">Hapus</button>
              </div>
              <textarea class="form-control item-kegiatan" rows="3" placeholder="Pendahuluan: ... Inti: ... Penutup: ...">${isi}</textarea>
          </div>`;
          document.getElementById('container-kegiatan').insertAdjacentHTML('beforeend', html);
      }

      function hapusPertemuan(id) {
          document.getElementById(`pertemuan-${id}`).remove();
      }

      // 4. Simpan Modul (Pack to JSON)
      function simpanModul() {
          const btn = document.getElementById('btn-mod-simpan');
          
          // Collect Data Kompleks
          // A. Identifikasi
          const identifikasi = {
              profil: document.getElementById('mod-profil').value,
              sarana: document.getElementById('mod-sarana').value
          };
          // B. Desain / Kompetensi
          const desain = {
              tp: document.getElementById('mod-tp').value,
              pemantik: document.getElementById('mod-pemantik').value
          };
          // C. Kegiatan (Looping)
          const kegiatan = [];
          document.querySelectorAll('.item-kegiatan').forEach((el, idx) => {
              kegiatan.push({ pertemuan: idx + 1, rincian: el.value });
          });
          // D. Asesmen & Lampiran
          const asesmen = { deskripsi: document.getElementById('mod-asesmen').value };
          const lampiran = { deskripsi: document.getElementById('mod-lampiran').value };

          // Validasi
          if(!document.getElementById('mod-materi').value) { alert("Materi Pokok wajib diisi!"); return; }

          btn.disabled = true; btn.innerText = 'Menyimpan...';

          const dataPayload = {
              rowIdx: document.getElementById('mod-rowIdx').value,
              fase: document.getElementById('mod-fase').value,
              kelas: document.getElementById('mod-kelas').value,
              materi: document.getElementById('mod-materi').value,
              alokasi: document.getElementById('mod-alokasi').value,
              identifikasi: identifikasi,
              desain: desain,
              kegiatan: kegiatan,
              asesmen: asesmen,
              lampiran: lampiran
          };

          const handler = r => { 
              alert(r); 
              resetFormModul(); 
              loadModul(); 
              gantiTabModul('data'); 
          };

          if(dataPayload.rowIdx) {
              google.script.run.withSuccessHandler(handler).updateModul(dataPayload);
          } else {
              google.script.run.withSuccessHandler(handler).simpanModul(dataPayload);
          }
      }
      // --- I. LOGIKA PROTA (GENERATOR OTOMATIS) ---
      function generateProta() {
          const fase = document.getElementById('prota-fase').value;
          const kelas = document.getElementById('prota-kelas').value;
          
          document.getElementById('prota-preview').style.display = 'block';
          document.getElementById('loader-prota').style.display = 'block';
          document.getElementById('konten-prota').style.display = 'none';
          
          // Set Identitas
          loadInfoSekolah('prota');
          document.getElementById('prota-fase-view').innerText = fase;
          document.getElementById('prota-kelas-view').innerText = kelas;
          
          google.script.run.withSuccessHandler(i => {
              if(document.getElementById('prota-guru-head')) document.getElementById('prota-guru-head').innerText = i.guru;
          }).getInfoSekolah();

          // Panggil Backend
          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-prota').style.display = 'none';
              document.getElementById('konten-prota').style.display = 'block';
              
              // 1. Render CP
              let htmlCP = '<ul style="padding-left:20px; margin-top:5px;">';
              if(data.cp.length === 0) {
                   htmlCP += '<li style="color:red;">Data CP belum diinput.</li>';
              } else {
                   data.cp.forEach(c => {
                       htmlCP += `<li style="margin-bottom:10px;"><b>${c.elemen}:</b> ${c.isi}</li>`;
                   });
              }
              htmlCP += '</ul>';
              document.getElementById('list-cp-prota').innerHTML = htmlCP;
              
              // 2. Render Tabel (Sem 1 & Sem 2)
              let htmlTable = '';
              
              // Helper Render Row
              const renderRows = (list, semLabel) => {
                  if(list.length === 0) return `<tr><td align="center"><b>${semLabel}</b></td><td colspan="4" align="center">- Data Kosong -</td></tr>`;
                  
                  let rows = '';
                  list.forEach((r, idx) => {
                      // Tampilkan Label Semester hanya di baris pertama
                      let label = (idx === 0) ? `<b>${semLabel}</b>` : ''; 
                      rows += `
                      <tr>
                          <td align="center" style="vertical-align:top;">${label}</td>
                          <td align="center" style="vertical-align:top;">${r.alur}</td>
                          <td style="vertical-align:top;"><b>${r.materi}</b></td>
                          <td style="text-align:justify;">${r.tujuan}</td>
                          <td align="center" style="vertical-align:top;">${r.waktu}</td>
                      </tr>`;
                  });
                  return rows;
              };

              htmlTable += renderRows(data.sem1, '1 (Satu)');
              htmlTable += `<tr style="background:#eee;"><td colspan="5" style="height:5px; padding:0;"></td></tr>`; // Separator
              htmlTable += renderRows(data.sem2, '2 (Dua)');
              
              document.getElementById('tabel-prota-body').innerHTML = htmlTable;
              
          }).getProtaView(kelas, fase);
      }
      // --- J. LOGIKA PROSEM (MATRIX INTERAKTIF) ---
      
      let gMatriks = {}; // Penyimpanan lokal sementara arsiran { "row_col": 1 }

      function bukaMenuProsem() {
          bukaHalaman('page-prosem');
          gantiTabProsem('data');
          loadDataProsem();
      }

      function gantiTabProsem(tab) {
          if(tab == 'data') {
              document.getElementById('view-pros-data').style.display='block';
              document.getElementById('view-pros-input').style.display='none';
              document.getElementById('tab-pros-data').classList.add('active');
              document.getElementById('tab-pros-input').classList.remove('active');
          } else {
              document.getElementById('view-pros-data').style.display='none';
              document.getElementById('view-pros-input').style.display='block';
              document.getElementById('tab-pros-data').classList.remove('active');
              document.getElementById('tab-pros-input').classList.add('active');
          }
      }

      // 1. GENERATE TABEL INPUT
      function loadTPForProsem() {
          const kls = document.getElementById('pros-kelas').value;
          const smt = document.getElementById('pros-smt').value;
          
          document.getElementById('loader-pros-input').style.display = 'block';
          document.getElementById('area-kerja-prosem').style.display = 'none';
          
          // Reset Matrix Global
          gMatriks = {}; 

          google.script.run.withSuccessHandler(listTP => {
              document.getElementById('loader-pros-input').style.display = 'none';
              document.getElementById('area-kerja-prosem').style.display = 'block';
              renderTabelProsem(listTP, smt);
              
              // Load Info Sekolah untuk Cetak
              loadInfoSekolah('cpros');
              document.getElementById('cpros-kelas').innerText = `${kls} / ${smt}`;
              document.getElementById('cpros-tahun').innerText = document.getElementById('pros-tahun').value;

          }).getTPForProsem(kls, smt);
      }

      // 2. RENDER TABEL (HTML)
      function renderTabelProsem(data, smt) {
          // A. Header Bulan
          const blnGanjil = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
          const blnGenap = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
          const listBulan = (smt == "1") ? blnGanjil : blnGenap;
          
          let thead = `
              <tr style="background:#f0f0f0;">
                  <th rowspan="2" width="5%">No</th>
                  <th rowspan="2">Materi Pokok / TP</th>
                  <th rowspan="2" width="5%">JP</th>
                  ${listBulan.map(b => `<th colspan="5">${b}</th>`).join('')}
              </tr>
              <tr style="background:#f0f0f0;">
                  ${listBulan.map((b, i) => `
                      <th style="font-size:8px;">1</th><th style="font-size:8px;">2</th><th style="font-size:8px;">3</th><th style="font-size:8px;">4</th><th style="font-size:8px;">5</th>
                  `).join('')}
              </tr>`;
          document.getElementById('pros-thead').innerHTML = thead;

          // B. Body TP
          let tbody = '';
          if(data.length === 0) {
              tbody = `<tr><td colspan="33" align="center" style="padding:20px;">Belum ada TP untuk kelas ini. Cek Menu Input TP.</td></tr>`;
          } else {
              data.forEach((r, idx) => {
                  let cells = '';
                  // Buat 30 Cell (6 Bulan x 5 Minggu)
                  for(let m=0; m<6; m++) {
                      for(let w=1; w<=5; w++) {
                          // ID Unik: baris_bulan_minggu (contoh: 0_0_1)
                          let cellId = `${idx}_${m}_${w}`;
                          // Cek apakah ada di gMatriks (untuk mode Edit)
                          let cls = gMatriks[cellId] ? 'is-checked' : '';
                          let val = gMatriks[cellId] ? '‚úî' : '';
                          
                          cells += `<td class="cell-check ${cls}" id="cell_${cellId}" onclick="toggleCell('${cellId}')">${val}</td>`;
                      }
                  }
                  
                  tbody += `
                  <tr>
                      <td align="center">${r.no}</td>
                      <td><b>${r.elemen}</b><br><span style="font-size:9px;">${r.tp}</span></td>
                      <td align="center">${r.jp}</td>
                      ${cells}
                  </tr>`;
              });
          }
          document.getElementById('pros-tbody').innerHTML = tbody;
      }

      // 3. INTERAKSI MATRIKS
      function toggleCell(id) {
          const el = document.getElementById('cell_' + id);
          if (el.classList.contains('is-checked')) {
              el.classList.remove('is-checked');
              el.innerText = "";
              delete gMatriks[id];
          } else {
              el.classList.add('is-checked');
              el.innerText = "‚úî";
              gMatriks[id] = 1; // Simpan state
          }
      }

      // 4. SIMPAN DATA
      function simpanProsem() {
          const btn = document.getElementById('btn-pros-simpan');
          btn.disabled = true; btn.innerHTML = 'Menyimpan...';
          
          // Ambil data TP dari tabel (Scraping row pertama utk deteksi)
          // Kita butuh simpan list TP juga agar saat load tidak perlu query TP lagi
          // Tapi untuk efisiensi, kita simpan matriks saja, dan TP diambil realtime saat render
          // Sesuai struktur DB Prosem Bapak: Elemen, TP, JP, Matriks disimpan per baris
          
          // Kita simpan per item TP yang ada di tabel
          const rows = document.getElementById('pros-tbody').querySelectorAll('tr');
          // Skip jika kosong
          if(rows.length <= 1 && rows[0].innerText.includes("Belum ada TP")) { alert("Data kosong"); return; }

          // Kita akan simpan satu object besar di baris pertama saja? 
          // TIDAK. Sesuai db_prosem.png, sepertinya Bapak ingin 1 baris DB = 1 baris TP.
          // Jadi kita loop rows.
          
          const fase = document.getElementById('pros-fase').value;
          const kls = document.getElementById('pros-kelas').value;
          const smt = document.getElementById('pros-smt').value;
          
          rows.forEach((tr, i) => {
              // Ambil data teks dari kolom
              const cells = tr.querySelectorAll('td');
              if(cells.length < 5) return;
              
              const no = cells[0].innerText;
              const tpText = cells[1].innerText; // Elemen + TP
              const jp = cells[2].innerText;
              
              // Filter matriks khusus baris ini (key dimulai dengan i_)
              let rowMatriks = {};
              for (const key in gMatriks) {
                  if (key.startsWith(i + "_")) {
                      rowMatriks[key] = "1";
                  }
              }
              
              // Data Packet Single Row
              const data = {
                  rowIdx: "", // New
                  fase: fase,
                  kelas: kls,
                  semester: smt,
                  elemen: tpText.split('\n')[0], // Baris 1 bold
                  tp: tpText.split('\n')[1] || "",
                  jp: jp,
                  matriks: rowMatriks
              };
              
              // Panggil Backend Simpan (Looping di client side agak riskan, tapi ok untuk data sedikit)
              // IDEALNYA: Kirim Array bulk ke backend.
              // Tapi script Prosem.gs simpanProsem() single row.
              // Kita modif dikit: Kita kirim per row via loop google.script.run (async)
              google.script.run.simpanProsem(data);
          });
          
          setTimeout(() => {
              alert("Data Prosem Berhasil Disimpan!");
              btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> SIMPAN PROSEM';
              gantiTabProsem('data');
              loadDataProsem();
          }, 2000); // Fake delay agar loop selesai
      }

      // 5. LOAD DATA TERSIMPAN
      function loadDataProsem() {
          const kls = document.getElementById('filter-pros-kelas').value;
          const smt = document.getElementById('filter-pros-sem').value;
          document.getElementById('container-list-prosem').innerHTML = 'Memuat...';
          
          google.script.run.withSuccessHandler(data => {
              if(data.length === 0) {
                  document.getElementById('container-list-prosem').innerHTML = '<p class="text-center">Belum ada data tersimpan.</p>';
                  return;
              }
              
              let html = `<table class="doc-table" style="width:100%"><thead><tr style="background:#eee;"><th>No</th><th>Materi / TP</th><th>JP</th><th width="15%">Aksi</th></tr></thead><tbody>`;
              
              data.forEach((r, i) => {
                  const rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                  html += `<tr>
                      <td align="center">${i+1}</td>
                      <td><b>${r.elemen}</b><br><small>${r.tp}</small></td>
                      <td align="center">${r.jp}</td>
                      <td align="center">
                          <button class="btn-mini bg-orange" onclick="viewProsemCetak('${kls}','${smt}')">Lihat Full</button>
                          <button class="btn-mini btn-hapus" onclick="hapusProsem('${r.rowIdx}')">X</button>
                      </td>
                  </tr>`;
              });
              html += `</tbody></table>`;
              document.getElementById('container-list-prosem').innerHTML = html;
          }).getDataProsem(kls, smt);
      }
      
      // 6. View Full & Cetak (Load Data + Matriks)
      function viewProsemCetak(kls, smt) {
          gantiTabProsem('input');
          document.getElementById('pros-kelas').value = kls;
          document.getElementById('pros-smt').value = smt;
          
          // Load ulang tapi inject Matriks dari DB
          document.getElementById('loader-pros-input').style.display = 'block';
          
          google.script.run.withSuccessHandler(data => {
              // Data = Array of Rows from DB
              // Kita perlu format ulang agar sesuai renderTabelProsem
              // Dan mengisi gMatriks
              
              gMatriks = {};
              let listTP = [];
              
              data.forEach((r, idx) => {
                  listTP.push({ no: r.no, elemen: r.elemen, tp: r.tp, jp: r.jp });
                  // Merge matriks
                  Object.assign(gMatriks, r.matriks);
              });
              
              document.getElementById('loader-pros-input').style.display = 'none';
              document.getElementById('area-kerja-prosem').style.display = 'block';
              renderTabelProsem(listTP, smt);
              
              // Load Info
              loadInfoSekolah('cpros');
              document.getElementById('cpros-kelas').innerText = `${kls} / ${smt}`;
              
          }).getDataProsem(kls, smt);
      }

      function hapusProsem(idx) {
          if(confirm("Hapus baris data ini?")) {
              google.script.run.withSuccessHandler(() => loadDataProsem()).hapusProsem(idx);
          }
      }
      
      function resetFormProsem() {
          gantiTabProsem('data');
          gMatriks = {};
      }
      // --- K. LOGIKA KKTP (KRITERIA KETERCAPAIAN) ---
      
      function bukaMenuKKTP() {
          bukaHalaman('page-kktp');
          gantiTabKKTP('data');
          loadDataKKTP();
      }

      function gantiTabKKTP(tab) {
          if(tab == 'data') {
              document.getElementById('view-kktp-data').style.display='block';
              document.getElementById('view-kktp-input').style.display='none';
              document.getElementById('tab-kktp-data').classList.add('active');
              document.getElementById('tab-kktp-input').classList.remove('active');
          } else {
              document.getElementById('view-kktp-data').style.display='none';
              document.getElementById('view-kktp-input').style.display='block';
              document.getElementById('tab-kktp-data').classList.remove('active');
              document.getElementById('tab-kktp-input').classList.add('active');
              loadTPForKKTPDropdown(); // Auto load TP saat tab input dibuka
          }
      }

      // 1. LOAD DATA TABEL
      function loadDataKKTP() {
          const kls = document.getElementById('filter-kktp-kelas').value;
          const smt = document.getElementById('filter-kktp-sem').value;
          
          document.getElementById('loader-kktp').style.display = 'block';
          document.getElementById('tabel-kktp-body').innerHTML = '';
          
          // Set Identitas Cetak
          loadInfoSekolah('ckktp');
          document.getElementById('ckktp-kelas').innerText = `${kls} / ${smt}`;
          
          // Tampilkan header detail saat cetak
          const cssPrint = document.createElement('style');
          cssPrint.innerHTML = '@media print { #header-detail-kktp { display: block !important; } }';
          document.head.appendChild(cssPrint);

          google.script.run.withSuccessHandler(data => {
              document.getElementById('loader-kktp').style.display = 'none';
              let html = '';
              
              if(data.length === 0) {
                  html = '<tr><td colspan="6" align="center" style="padding:20px;">Belum ada data KKTP.</td></tr>';
              } else {
                  data.forEach((r, i) => {
                      const rJson = JSON.stringify(r).replace(/"/g, '&quot;');
                      html += `
                      <tr>
                          <td align="center">${r.alur || (i+1)}</td>
                          <td><b>${r.bab}</b><br><small>${r.materi}</small></td>
                          <td style="text-align:justify; font-size:11px;">${r.kriteria}</td>
                          <td align="center" style="font-weight:bold;">${r.kategori}</td>
                          <td style="font-size:11px;">${r.tindak}</td>
                          <td align="center" class="btn-print-hide">
                              <button class="btn-mini btn-edit" onclick="editKKTP(${rJson})"><i class="fas fa-edit"></i></button>
                              <button class="btn-mini btn-hapus" onclick="hapusKKTP('${r.rowIdx}')"><i class="fas fa-trash"></i></button>
                          </td>
                      </tr>`;
                  });
              }
              document.getElementById('tabel-kktp-body').innerHTML = html;
          }).getDataKKTP(kls, smt);
      }

      // 2. LOAD DROPDOWN TP (FITUR PINTAR DARI PROSEM)
      function loadTPForKKTPDropdown() {
          const kls = document.getElementById('kktp-kelas').value;
          const smt = document.getElementById('kktp-smt').value;
          
          google.script.run.withSuccessHandler(tps => {
              let h = '';
              tps.forEach(t => h += `<option value="${t}">`);
              document.getElementById('list-tp-kktp').innerHTML = h;
          }).getTPFromProsem(kls, smt);
      }

      // 3. SIMPAN KKTP
      function simpanKKTP() {
          const btn = document.getElementById('btn-kktp-simpan');
          // Ambil TP yang dipilih (Format di DB KKTP kolom G adalah Materi/TP)
          // Kita asumsikan input TP berisi kalimat TP.
          
          const data = {
              rowIdx: document.getElementById('kktp-rowIdx').value,
              fase: document.getElementById('kktp-fase').value,
              kelas: document.getElementById('kktp-kelas').value,
              semester: document.getElementById('kktp-smt').value,
              bab: document.getElementById('kktp-bab').value,
              alur: document.getElementById('kktp-alur').value,
              materi: document.getElementById('kktp-tp').value, // Kita pakai input TP masuk ke kolom Materi/TP
              kriteria: document.getElementById('kktp-kriteria').value,
              kategori: document.getElementById('kktp-kategori').value,
              tindak: document.getElementById('kktp-tindak').value
          };

          if(!data.bab || !data.materi || !data.kategori) { alert("Lengkapi Bab, TP, dan Interval!"); return; }

          btn.disabled = true; btn.innerText = 'Menyimpan...';

          const handler = r => {
              alert(r);
              resetFormKKTP();
              loadDataKKTP();
              gantiTabKKTP('data');
          };

          if(data.rowIdx) {
              google.script.run.withSuccessHandler(handler).updateKKTP(data);
          } else {
              google.script.run.withSuccessHandler(handler).simpanKKTP(data);
          }
      }

      // 4. EDIT & HAPUS
      function editKKTP(d) {
          gantiTabKKTP('input');
          document.getElementById('kktp-rowIdx').value = d.rowIdx;
          document.getElementById('kktp-fase').value = d.fase;
          document.getElementById('kktp-kelas').value = d.kelas;
          document.getElementById('kktp-smt').value = d.semester;
          document.getElementById('kktp-bab').value = d.bab;
          document.getElementById('kktp-alur').value = d.alur;
          document.getElementById('kktp-tp').value = d.materi;
          document.getElementById('kktp-kriteria').value = d.kriteria;
          document.getElementById('kktp-kategori').value = d.kategori;
          document.getElementById('kktp-tindak').value = d.tindak;

          document.getElementById('btn-kktp-simpan').innerHTML = '<i class="fas fa-sync"></i> UPDATE KKTP';
          document.getElementById('btn-kktp-batal').style.display = 'block';
      }

      function hapusKKTP(id) {
          if(confirm("Hapus Data KKTP ini?")) {
              google.script.run.withSuccessHandler(r => loadDataKKTP()).hapusKKTP(id);
          }
      }

      function resetFormKKTP() {
          document.getElementById('kktp-rowIdx').value = "";
          document.getElementById('kktp-bab').value = "";
          document.getElementById('kktp-alur').value = "";
          document.getElementById('kktp-tp').value = "";
          document.getElementById('kktp-kriteria').value = "";
          document.getElementById('kktp-kategori').value = "";
          document.getElementById('kktp-tindak').value = "";
          
          document.getElementById('btn-kktp-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN KKTP';
          document.getElementById('btn-kktp-batal').style.display = 'none';
          document.getElementById('btn-kktp-simpan').disabled = false;
      }

      // 5. Edit Modul (Unpack JSON)
      function editModul(d) {
          gantiTabModul('input');
          document.getElementById('mod-rowIdx').value = d.rowIdx;
          document.getElementById('mod-fase').value = d.fase;
          document.getElementById('mod-kelas').value = d.kelas;
          document.getElementById('mod-materi').value = d.materi;
          document.getElementById('mod-alokasi').value = d.alokasi;
          
          // Unpack Objects
          document.getElementById('mod-profil').value = d.identifikasi.profil || "";
          document.getElementById('mod-sarana').value = d.identifikasi.sarana || "";
          document.getElementById('mod-tp').value = d.desain.tp || "";
          document.getElementById('mod-pemantik').value = d.desain.pemantik || "";
          document.getElementById('mod-asesmen').value = d.asesmen.deskripsi || "";
          document.getElementById('mod-lampiran').value = d.lampiran.deskripsi || "";

          // Unpack Kegiatan (Reset dulu container)
          document.getElementById('container-kegiatan').innerHTML = "";
          pertemuanCount = 0;
          if(d.kegiatan && d.kegiatan.length > 0) {
              d.kegiatan.forEach(k => tambahPertemuan(k));
          } else {
              tambahPertemuan();
          }

          document.getElementById('btn-mod-simpan').innerHTML = '<i class="fas fa-sync"></i> UPDATE MODUL';
          document.getElementById('btn-mod-batal').style.display = 'block';
      }

      function resetFormModul() {
          document.getElementById('mod-rowIdx').value = "";
          document.getElementById('mod-materi').value = "";
          document.getElementById('mod-alokasi').value = "";
          document.getElementById('mod-profil').value = "";
          document.getElementById('mod-sarana').value = "";
          document.getElementById('mod-tp').value = "";
          document.getElementById('mod-pemantik').value = "";
          document.getElementById('mod-asesmen').value = "";
          document.getElementById('mod-lampiran').value = "";
          document.getElementById('container-kegiatan').innerHTML = "";
          pertemuanCount = 0; 
          tambahPertemuan();

          document.getElementById('btn-mod-simpan').innerHTML = '<i class="fas fa-save"></i> SIMPAN MODUL';
          document.getElementById('btn-mod-batal').style.display = 'none';
          document.getElementById('btn-mod-simpan').disabled = false;
      }

      function hapusModul(idx) {
          if(confirm("Hapus Modul Ajar ini?")) {
              google.script.run.withSuccessHandler(r => { loadModul(); }).hapusModul(idx);
          }
      }

      // 6. Cetak Modul View (Generate Document)
      function cetakModulView(d) {
          document.getElementById('view-modul-data').style.display = 'none';
          document.getElementById('view-modul-input').style.display = 'none';
          document.getElementById('view-modul-cetak').style.display = 'block';
          
          // Load Info Sekolah
          loadInfoSekolah('cmod');
          
          // Set Header
          document.getElementById('cmod-fase').innerText = d.fase;
          document.getElementById('cmod-kelas').innerText = d.kelas;
          document.getElementById('cmod-materi').innerText = d.materi;
          document.getElementById('cmod-alokasi').innerText = d.alokasi;

          // Generate Konten
          let html = `
          <div style="font-size:12px; line-height:1.5;">
              <h4 style="border-bottom:1px solid #000; margin-top:15px;">1. TUJUAN PEMBELAJARAN</h4>
              <p><b>Tujuan:</b> ${d.desain.tp || "-"}</p>
              <p><b>Profil Pelajar Pancasila:</b> ${d.identifikasi.profil || "-"}</p>
              
              <h4 style="border-bottom:1px solid #000; margin-top:15px;">2. LANGKAH PEMBELAJARAN</h4>
              <p><b>Pertanyaan Pemantik:</b> ${d.desain.pemantik || "-"}</p>
              <p><b>Sarana & Media:</b> ${d.identifikasi.sarana || "-"}</p>
              
              <table class="doc-table" style="width:100%; margin-top:10px;">
                  <thead><tr style="background:#eee;"><th>Pertemuan</th><th>Rincian Kegiatan</th></tr></thead>
                  <tbody>`;
          
          if(d.kegiatan && d.kegiatan.length > 0) {
              d.kegiatan.forEach(k => {
                  // Ganti baris baru jadi <br> agar rapi saat diprint
                  let ket = k.rincian.replace(/\n/g, '<br>'); 
                  html += `<tr><td width="15%" align="center">Ke-${k.pertemuan}</td><td>${ket}</td></tr>`;
              });
          } else {
              html += `<tr><td colspan="2">-</td></tr>`;
          }

          html += `</tbody></table>
              
              <h4 style="border-bottom:1px solid #000; margin-top:15px;">3. ASESMEN & LAMPIRAN</h4>
              <p><b>Asesmen:</b><br>${(d.asesmen.deskripsi || "-").replace(/\n/g, '<br>')}</p>
              <p><b>Lampiran:</b><br>${(d.lampiran.deskripsi || "-").replace(/\n/g, '<br>')}</p>
          </div>`;

          document.getElementById('konten-cetak-modul').innerHTML = html;
      }

      // --- 5. LOGIKA PENGATURAN ---
      function bukaPengaturan() {
         // bukaHalaman('page-pengaturan');
         google.script.run.withSuccessHandler(data => {
            for (const key in data) {
               if (document.getElementById('set-' + key)) document.getElementById('set-' + key).value = data[key];
            }
         }).getAllPengaturan();
      }
      
      function simpanPengaturan() {
         const btn = document.getElementById('btn-save-set'); btn.disabled = true; btn.innerText = 'Menyimpan...';
         const data = {
            nama_sekolah: document.getElementById('set-nama_sekolah').value,
            mata_pelajaran: document.getElementById('set-mata_pelajaran').value,
            kota_sekolah: document.getElementById('set-kota_sekolah').value,
            tahun_pelajaran: document.getElementById('set-tahun_pelajaran').value,
            nama_guru: document.getElementById('set-nama_guru').value,
            nip_guru: document.getElementById('set-nip_guru').value,
            kepala_sekolah: document.getElementById('set-kepala_sekolah').value,
            nip_kepsek: document.getElementById('set-nip_kepsek').value,
            folder_foto_siswa: document.getElementById('set-folder_foto_siswa').value,
            kalender_img: document.getElementById('set-kalender_img').value,
            kalender_pdf: document.getElementById('set-kalender_pdf').value,
            deskripsi_cp_prota: document.getElementById('set-deskripsi_cp_prota').value
         };
         google.script.run.withSuccessHandler(r => {
            alert(r); btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> SIMPAN PERUBAHAN';
         }).saveAllPengaturan(data);
      }

      // --- 6. LOGIKA BANK SOAL ---
      function bukaBankSoal() { bukaHalaman('page-banksoal'); gantiTabSoal('input'); loadInfoSekolah('soal'); loadDropdownBab(); }
      function loadDropdownBab() { google.script.run.withSuccessHandler(res => { let h='<option value="">-- Pilih BAB --</option>'; res.listBab.forEach(b=>h+=`<option value="${b}">${b}</option>`); document.getElementById('filter-bab').innerHTML=h; let d=''; res.listBab.forEach(b=>d+=`<option value="${b}">`); document.getElementById('list-bab-db').innerHTML=d; }).getBankSoal(""); }
      function gantiTabSoal(mode) { if(mode=='input'){document.getElementById('banksoal-input-view').style.display='block';document.getElementById('banksoal-cetak-view').style.display='none';document.getElementById('tab-soal-input').classList.add('active');document.getElementById('tab-soal-cetak').classList.remove('active');}else{document.getElementById('banksoal-input-view').style.display='none';document.getElementById('banksoal-cetak-view').style.display='block';document.getElementById('tab-soal-input').classList.remove('active');document.getElementById('tab-soal-cetak').classList.add('active');loadDropdownBab();}}
      function simpanSoal() { const btn=document.getElementById('btn-simpan-soal'); btn.disabled=true; btn.innerText='Menyimpan...'; const data={ id:document.getElementById('soal-id').value, bab:document.getElementById('soal-bab').value, jenis:document.getElementById('soal-jenis').value, tp:document.getElementById('soal-tp').value, kategori:document.getElementById('soal-kategori').value, tanya:document.getElementById('soal-tanya').value, jawab:document.getElementById('soal-jawab').value, skor:document.getElementById('soal-skor').value }; google.script.run.withSuccessHandler(r=>{ alert(r); btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> SIMPAN SOAL'; if(!data.id){document.getElementById('soal-tanya').value="";document.getElementById('soal-jawab').value="";}else{document.getElementById('soal-id').value="";document.getElementById('soal-tanya').value="";document.getElementById('soal-jawab').value="";} loadDropdownBab(); }).simpanSoal(data); }
      function loadBankSoalView() { const bab=document.getElementById('filter-bab').value; const kls=document.getElementById('filter-kelas-input').value; document.getElementById('soal-kelas-view').innerText=kls||"VII / D"; document.getElementById('konten-bank-soal').innerHTML='<div class="text-center">Memuat data...</div>'; google.script.run.withSuccessHandler(data=>{ let html=`<h4 style="text-transform:uppercase; border-bottom:2px solid #333; padding-bottom:5px;">BAB: ${bab||"SEMUA MATERI"}</h4>`; html+=`<h5>A. Soal Formatif</h5><table class="doc-table" style="width:100%"><thead><tr style="background:#eee;"><th width="5%">No</th><th width="15%">Alur TP</th><th width="15%">Kategori</th><th>Pertanyaan</th><th width="15%">Jawaban</th><th width="8%">Skor</th><th width="8%" class="btn-print-hide">Aksi</th></tr></thead><tbody>`; if(data.formatif.length===0)html+=`<tr><td colspan="7" align="center">Belum ada soal formatif.</td></tr>`; else data.formatif.forEach((s,i)=>{ const sStr=JSON.stringify(s).replace(/"/g,'&quot;'); html+=`<tr><td align="center">${i+1}</td><td>${s.tp}</td><td>${s.kategori}</td><td>${s.tanya}</td><td>${s.jawab}</td><td>${s.skor}</td><td class="btn-print-hide"><button class="btn-mini btn-edit" onclick="editSoal(${sStr})">E</button><button class="btn-mini btn-hapus" onclick="hapusSoal('${s.id}')">X</button></td></tr>`; }); html+=`</tbody></table>`; html+=`<h5 style="margin-top:20px;">B. Soal Sumatif</h5><table class="doc-table" style="width:100%"><thead><tr style="background:#eee;"><th width="5%">No</th><th width="15%">Alur TP</th><th width="15%">Kategori</th><th>Pertanyaan</th><th width="15%">Jawaban</th><th width="8%">Skor/KKTP</th><th width="8%" class="btn-print-hide">Aksi</th></tr></thead><tbody>`; if(data.sumatif.length===0)html+=`<tr><td colspan="7" align="center">Belum ada soal sumatif.</td></tr>`; else data.sumatif.forEach((s,i)=>{ const sStr=JSON.stringify(s).replace(/"/g,'&quot;'); html+=`<tr><td align="center">${i+1}</td><td>${s.tp}</td><td>${s.kategori}</td><td>${s.tanya}</td><td>${s.jawab}</td><td>${s.skor}</td><td class="btn-print-hide"><button class="btn-mini btn-edit" onclick="editSoal(${sStr})">E</button><button class="btn-mini btn-hapus" onclick="hapusSoal('${s.id}')">X</button></td></tr>`; }); html+=`</tbody></table>`; document.getElementById('konten-bank-soal').innerHTML=html; }).getBankSoal(bab); }
      function editSoal(d) { gantiTabSoal('input'); document.getElementById('soal-id').value=d.id; document.getElementById('soal-bab').value=d.bab; document.getElementById('soal-jenis').value=d.jenis; document.getElementById('soal-tp').value=d.tp; document.getElementById('soal-kategori').value=d.kategori; document.getElementById('soal-skor').value=d.skor; document.getElementById('soal-tanya').value=d.tanya; document.getElementById('soal-jawab').value=d.jawab; }
      function hapusSoal(id) { if(confirm("Hapus soal ini?")) { google.script.run.withSuccessHandler(()=>{loadBankSoalView();}).hapusSoal(id); } }

      // --- 7. LOGIKA AGENDA ---
      function gantiTabAgenda(mode) { if(mode=='input') { document.getElementById('agenda-input-view').style.display='block'; document.getElementById('agenda-riwayat-view').style.display='none'; document.getElementById('tab-agn-input').classList.add('active'); document.getElementById('tab-agn-riwayat').classList.remove('active'); } else { document.getElementById('agenda-input-view').style.display='none'; document.getElementById('agenda-riwayat-view').style.display='block'; document.getElementById('tab-agn-input').classList.remove('active'); document.getElementById('tab-agn-riwayat').classList.add('active'); } }
      function bukaAgenda() { bukaHalaman('page-agenda'); gantiTabAgenda('input'); resetFormAgenda(); loadInfoSekolah('v'); loadOpsiAgenda(); updateAgendaView(); }
      function loadOpsiAgenda() { google.script.run.withSuccessHandler(d => { isiDatalist('list-tp-db', d.tps); isiDatalist('list-jadwal-db', d.jadwals); isiDatalist('list-materi-db', d.materis); }).getOpsiAgenda(); }
      function isiDatalist(id, arr) { let h = ''; arr.forEach(x => h += `<option value="${x}">`); document.getElementById(id).innerHTML = h; }
      function parseJadwal(val) { if(val.includes('|')) { const parts = val.split('|'); document.getElementById('v-waktu').innerText = parts[1].trim(); const kls = parts[2].replace('Kls','').trim(); document.getElementById('v-kelas-cell').innerText = kls; document.getElementById('v-kelas').innerText = kls + " / Fase D"; } else { document.getElementById('v-waktu').innerText = val; } }
      function updateAgendaView() { document.getElementById('v-hari').innerText = document.getElementById('agn-hari').value; document.getElementById('v-tgl').innerText = document.getElementById('agn-tanggal').value; document.getElementById('v-tgl-ttd').innerText = document.getElementById('agn-tanggal').value; document.getElementById('v-tp').innerText = document.getElementById('agn-tp').value; document.getElementById('v-materi').innerText = document.getElementById('agn-materi').value; document.getElementById('v-alat').innerText = document.getElementById('agn-alat').value; document.getElementById('v-tugas').innerText = document.getElementById('agn-tugas').value; document.getElementById('v-catatan').innerText = document.getElementById('agn-catatan').value; }
      function simpanAgenda() { const btn = document.getElementById('btn-simpan-agn'); btn.disabled=true; btn.innerText='Menyimpan...'; const data = { id: document.getElementById('agn-id').value, hari: document.getElementById('agn-hari').value, tanggal: document.getElementById('agn-tanggal').value, tp: document.getElementById('agn-tp').value, waktu: document.getElementById('agn-jadwal').value, materi: document.getElementById('agn-materi').value, alat: document.getElementById('agn-alat').value, tugas: document.getElementById('agn-tugas').value, catatan: document.getElementById('agn-catatan').value }; google.script.run.withSuccessHandler(r => { alert(r); btn.disabled=false; if(document.getElementById('agn-id').value) { resetFormAgenda(); gantiTabAgenda('riwayat'); loadLaporanAgenda(); } else { btn.innerHTML = '<i class="fas fa-save"></i> SIMPAN KE DB'; } }).simpanAgenda(data); }
      function resetFormAgenda() { document.getElementById('agn-id').value = ""; document.getElementById('agn-tanggal').valueAsDate = new Date(); document.getElementById('agn-tp').value = ""; document.getElementById('agn-jadwal').value = ""; document.getElementById('agn-materi').value = ""; document.getElementById('agn-alat').value = "Buku Paket, Spidol"; document.getElementById('agn-tugas').value = "Latihan Halaman..."; document.getElementById('agn-catatan').value = "-"; document.getElementById('btn-simpan-agn').innerHTML = '<i class="fas fa-save"></i> SIMPAN KE DB'; document.getElementById('btn-batal-edit').style.display = 'none'; updateAgendaView(); }
      function loadLaporanAgenda() { const m = document.getElementById('lapor-mulai').value; const s = document.getElementById('lapor-selesai').value; if(!m || !s) { alert("Pilih tanggal mulai dan selesai!"); return; } document.getElementById('laporan-container').innerHTML = '<div style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Memuat Data...</div>'; google.script.run.withSuccessHandler(data => { renderTabelLaporan(data, m, s); }).getLaporanAgenda(m, s); }
      function renderTabelLaporan(data, tglMulai, tglSelesai) { let html = `<div class="doc-header" style="display:block !important;"><h3>JURNAL MENGAJAR GURU</h3><p>Periode: ${tglMulai} s.d. ${tglSelesai}</p></div><table class="doc-table" style="width:100%"><thead><tr style="background:#eee;"><th width="5%">No</th><th width="15%">Tanggal</th><th width="15%">Waktu/Kelas</th><th width="30%">Materi / TP</th><th width="20%">Catatan</th><th width="15%" class="btn-print-hide">Aksi</th></tr></thead><tbody>`; if(data.length === 0) { html += `<tr><td colspan="6" align="center">Tidak ada data.</td></tr>`; } else { data.forEach((d, idx) => { const dataStr = JSON.stringify(d).replace(/"/g, '&quot;'); html += `<tr><td align="center">${idx+1}</td><td>${d.hari}, ${d.tanggal}</td><td>${d.waktu}</td><td><b>Materi:</b> ${d.materi}<br><small>TP: ${d.tp}</small></td><td>${d.catatan}</td><td align="center" class="btn-print-hide"><button class="btn-mini btn-edit" onclick="editAgendaClick(${dataStr})"><i class="fas fa-edit"></i></button><button class="btn-mini btn-hapus" onclick="hapusAgendaClick('${d.id}')"><i class="fas fa-trash"></i></button></td></tr>`; });} html += `</tbody></table><table class="signature-table" border="0" style="margin-top:30px;"><tr><td width="50%"><p>Mengetahui,</p><p>Kepala Sekolah</p><div class="ttd-space"></div><p class="bold-underline" id="lapor-kepsek">...</p><p>NIP. <span id="lapor-nip-kepsek"></span></p></td><td width="50%"><p><span id="lapor-kota">...</span>, <span id="lapor-tgl">...</span></p><p>Guru Mapel</p><div class="ttd-space"></div><p class="bold-underline" id="lapor-guru">...</p><p>NIP. <span id="lapor-nip-guru"></span></p></td></tr></table>`; document.getElementById('laporan-container').innerHTML = html; loadInfoSekolah('lapor'); }
      function editAgendaClick(d) { gantiTabAgenda('input'); document.getElementById('agn-id').value = d.id; document.getElementById('agn-hari').value = d.hari; document.getElementById('agn-tanggal').value = d.tanggal; document.getElementById('agn-jadwal').value = d.waktu; document.getElementById('agn-tp').value = d.tp; document.getElementById('agn-materi').value = d.materi; document.getElementById('agn-alat').value = d.alat; document.getElementById('agn-tugas').value = d.tugas; document.getElementById('agn-catatan').value = d.catatan; document.getElementById('btn-simpan-agn').innerHTML = '<i class="fas fa-sync"></i> UPDATE DATA'; document.getElementById('btn-batal-edit').style.display = 'block'; parseJadwal(d.waktu); updateAgendaView(); }
      function hapusAgendaClick(id) { if(confirm("Hapus data ini?")) { google.script.run.withSuccessHandler(r => { alert(r); loadLaporanAgenda(); }).hapusAgenda(id); } }

      // --- 8. LOGIKA NILAI ---
      let gConfig = { formatif: [], sumatif: [] }; let gNilai = {}; let gSiswa = [];
      function bukaNilai() { bukaHalaman('page-nilai'); google.script.run.withSuccessHandler(kelas => { let h = '<option value="">-- Pilih Kelas --</option>'; kelas.forEach(k => h += `<option value="${k}">${k}</option>`); document.getElementById('nilai-kelas').innerHTML = h; }).getListKelasMurid(); document.getElementById('nilai-container').innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">Silakan pilih Kelas & Semester lalu klik tombol <b>MUAT DATA</b> di atas.</div>'; document.getElementById('panel-kontrol-nilai').style.display = 'none'; }
      function loadDaftarNilai() { const k = document.getElementById('nilai-kelas').value; const s = document.getElementById('nilai-sem').value; if(!k) { alert("Pilih kelas dulu!"); return; } document.getElementById('nilai-container').innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Memuat Data Siswa...</div>'; loadInfoSekolah('nil'); google.script.run.withSuccessHandler(data => { gSiswa = data.siswa; gConfig = data.config; gNilai = data.nilai; document.getElementById('panel-kontrol-nilai').style.display = 'block'; renderTabelNilai(); }).getDataNilai(k, s); }
      function renderTabelNilai() { const k = document.getElementById('nilai-kelas').value; const s = document.getElementById('nilai-sem').value; let html = `<div class="doc-header" style="display:block !important; margin-bottom:10px;"><h3>DAFTAR NILAI SEKOLAH PENGGERAK</h3><p>Kelas: ${k} | Semester: ${s} | TP: 2025/2026</p></div>`; html += `<table class="doc-table" style="width:100%; font-size:10px;"><thead>`; let colF = 0; gConfig.formatif.forEach(m => colF += m.tps.length); colF += 1; html += `<tr><th rowspan="3" width="30px">NO</th><th rowspan="3" width="200px" style="text-align:left;">NAMA PESERTA DIDIK</th><th colspan="${colF}" style="background:#e3f2fd;">FORMATIF (F)</th><th colspan="${gConfig.sumatif.length + 1}" style="background:#fff3e0;">SUMATIF (S)</th><th colspan="3" style="background:#ffebee;">AKHIR SEMESTER (AS)</th><th rowspan="3" width="50px" style="background:#e8f5e9;">NILAI<br>RAPOR</th></tr>`; html += `<tr>`; gConfig.formatif.forEach((mat, idx) => { html += `<th colspan="${mat.tps.length}" style="background:#e3f2fd; position:relative; padding:0;"><input type="text" value="${mat.materi}" onchange="updateMateriName(${idx}, this.value)" class="header-input" placeholder="Nama Materi..."><button class="btn-mini btn-hapus btn-print-hide" onclick="hapusMateri(${idx})" style="position:absolute; top:0; right:0; font-size:8px; padding:0 3px;">x</button></th>`; }); html += `<th rowspan="2" width="40px" style="background:#bbdefb;">NA<br>(F)</th>`; gConfig.sumatif.forEach((sum, idx) => { html += `<th rowspan="2" width="40px" style="background:#fff3e0; position:relative; padding:0;"><input type="text" value="${sum}" onchange="updateSumatifName(${idx}, this.value)" class="header-input" style="writing-mode: vertical-rl; transform: rotate(180deg); height:80px;"><button class="btn-mini btn-hapus btn-print-hide" onclick="hapusSumatif(${idx})" style="position:absolute; top:0; right:0; font-size:8px; padding:0 3px;">x</button></th>`; }); html += `<th rowspan="2" width="40px" style="background:#ffe0b2;">NA<br>(S)</th><th rowspan="2" width="40px">NON<br>TES</th><th rowspan="2" width="40px">TES</th><th rowspan="2" width="40px" style="background:#ffcdd2;">NA<br>(AS)</th></tr>`; html += `<tr>`; gConfig.formatif.forEach((mat, mIdx) => { mat.tps.forEach((tp, tIdx) => { html += `<th width="35px" style="background:#e3f2fd; position:relative; padding:0;"><input type="text" value="${tp}" onchange="updateTPName(${mIdx}, ${tIdx}, this.value)" class="header-input">${tIdx===mat.tps.length-1 ? `<button class="btn-mini bg-green btn-print-hide" onclick="tambahTP(${mIdx})" style="position:absolute; bottom:-12px; left:0; width:100%; font-size:8px; padding:0; z-index:10;">+TP</button>` : ''}</th>`; }); }); html += `</tr></thead><tbody>`; if(gSiswa.length === 0) { html += `<tr><td colspan="50" class="text-center" style="padding:20px;">Belum ada siswa di kelas ini.</td></tr>`; } else { gSiswa.forEach((sis, sIdx) => { let n = gNilai[sis.nama] || {}; html += `<tr><td align="center">${sIdx+1}</td><td style="text-align:left; font-weight:500;">${sis.nama}</td>`; let totalF = 0, countF = 0; gConfig.formatif.forEach((mat, mIdx) => { mat.tps.forEach((tp, tIdx) => { let key = `F_${mIdx}_${tIdx}`; let val = n[key] || ""; if(val !== "") { totalF += parseFloat(val); countF++; } html += `<td style="padding:0;"><input type="number" class="inp-nilai" value="${val}" onchange="simpanLokal('${sis.nama}', '${key}', this.value)"></td>`; }); }); let naF = countF > 0 ? Math.round(totalF/countF) : ""; html += `<td align="center" style="background:#e3f2fd; font-weight:bold;">${naF}</td>`; let totalS = 0, countS = 0; gConfig.sumatif.forEach((sum, sumIdx) => { let key = `S_${sumIdx}`; let val = n[key] || ""; if(val !== "") { totalS += parseFloat(val); countS++; } html += `<td style="padding:0;"><input type="number" class="inp-nilai" value="${val}" onchange="simpanLokal('${sis.nama}', '${key}', this.value)"></td>`; }); let naS = countS > 0 ? Math.round(totalS/countS) : ""; html += `<td align="center" style="background:#fff3e0; font-weight:bold;">${naS}</td>`; let vNon = n['AS_NON'] || ""; let vTes = n['AS_TES'] || ""; html += `<td style="padding:0;"><input type="number" class="inp-nilai" value="${vNon}" onchange="simpanLokal('${sis.nama}', 'AS_NON', this.value)"></td>`; html += `<td style="padding:0;"><input type="number" class="inp-nilai" value="${vTes}" onchange="simpanLokal('${sis.nama}', 'AS_TES', this.value)"></td>`; let naAS = ""; if(vNon !== "" && vTes !== "") naAS = Math.round((parseFloat(vNon) + parseFloat(vTes)) / 2); else if(vNon !== "") naAS = vNon; else if(vTes !== "") naAS = vTes; html += `<td align="center" style="background:#ffebee; font-weight:bold;">${naAS}</td>`; let sumRapor = 0, countRapor = 0; if(naF !== "") { sumRapor += parseFloat(naF); countRapor++; } if(naS !== "") { sumRapor += parseFloat(naS); countRapor++; } if(naAS !== "") { sumRapor += parseFloat(naAS); countRapor++; } let rapor = countRapor > 0 ? Math.round(sumRapor/countRapor) : ""; let color = (rapor !== "" && rapor < 70) ? "red" : "black"; html += `<td align="center" style="background:#e8f5e9; font-weight:bold; font-size:12px; color:${color};">${rapor}</td></tr>`; }); } html += `</tbody></table>`; document.getElementById('nilai-container').innerHTML = html; document.getElementById('cetak-nilai-footer').style.display = 'block'; }
      function simpanLokal(namaSiswa, keyKode, nilaiBaru) { if(!gNilai[namaSiswa]) gNilai[namaSiswa] = {}; gNilai[namaSiswa][keyKode] = nilaiBaru; renderTabelNilai(); }
      function tambahMateri() { gConfig.formatif.push({ materi: "Materi Baru", tps: ["TP 1"] }); renderTabelNilai(); }
      function tambahTP(mIdx) { let count = gConfig.formatif[mIdx].tps.length + 1; gConfig.formatif[mIdx].tps.push("TP " + count); renderTabelNilai(); }
      function tambahSumatif() { let count = gConfig.sumatif.length + 1; gConfig.sumatif.push("Sumatif " + count); renderTabelNilai(); }
      function hapusMateri(idx) { if(confirm("Hapus Materi ini beserta semua nilainya?")) { gConfig.formatif.splice(idx, 1); renderTabelNilai(); } }
      function hapusSumatif(idx) { if(confirm("Hapus Kolom Sumatif ini?")) { gConfig.sumatif.splice(idx, 1); renderTabelNilai(); } }
      function updateMateriName(idx, val) { gConfig.formatif[idx].materi = val; }
      function updateSumatifName(idx, val) { gConfig.sumatif[idx] = val; }
      function updateTPName(mIdx, tIdx, val) { gConfig.formatif[mIdx].tps[tIdx] = val; }
      function prosesSimpanNilai() { const btn = document.querySelector('#panel-kontrol-nilai .btn-simpan'); if(btn){btn.disabled=true; btn.innerHTML='Menyimpan...';} const dataPayload = { kelas: document.getElementById('nilai-kelas').value, semester: document.getElementById('nilai-sem').value, tahun: "2025/2026", config: gConfig, nilaiSiswa: gNilai }; google.script.run.withSuccessHandler(r => { alert(r); if(btn){btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> SIMPAN SEMUA';} }).simpanNilai(dataPayload); }
    </script>
  </body>
</html>
